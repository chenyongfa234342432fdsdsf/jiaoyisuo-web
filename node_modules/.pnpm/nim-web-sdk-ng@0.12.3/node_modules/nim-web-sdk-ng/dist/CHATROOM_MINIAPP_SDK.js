/**
 * 
 *   Version: 0.12.3
 * 
 *   Git Hash: 1e29863397d62295db762f58beb5f2b3b9fe846b
 * 
 *   Created At: 2023/3/9 下午6:30:10
 * 
 *   Target: CHATROOM_MINIAPP_SDK.js
 *   
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).NIM=t()}(this,(function(){"use strict";function __rest(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}function __awaiter(e,t,r,o){return new(r||(r=Promise))((function(n,i){function fulfilled(e){try{step(o.next(e))}catch(e){i(e)}}function rejected(e){try{step(o.throw(e))}catch(e){i(e)}}function step(e){e.done?n(e.value):function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var t=createCommonjsModule((function(e){var t=Object.prototype.hasOwnProperty,r="~";function Events(){}function EE(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function addListener(e,t,o,n,i){if("function"!=typeof o)throw new TypeError("The listener must be a function");var s=new EE(o,n||e,i),a=r?r+t:t;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],s]:e._events[a].push(s):(e._events[a]=s,e._eventsCount++),e}function clearEvent(e,t){0==--e._eventsCount?e._events=new Events:delete e._events[t]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(r=!1)),EventEmitter.prototype.eventNames=function eventNames(){var e,o,n=[];if(0===this._eventsCount)return n;for(o in e=this._events)t.call(e,o)&&n.push(r?o.slice(1):o);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},EventEmitter.prototype.listeners=function listeners(e){var t=r?r+e:e,o=this._events[t];if(!o)return[];if(o.fn)return[o.fn];for(var n=0,i=o.length,s=new Array(i);n<i;n++)s[n]=o[n].fn;return s},EventEmitter.prototype.listenerCount=function listenerCount(e){var t=r?r+e:e,o=this._events[t];return o?o.fn?1:o.length:0},EventEmitter.prototype.emit=function emit(e,t,o,n,i,s){var a=r?r+e:e;if(!this._events[a])return!1;var c,l,u=this._events[a],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,o),!0;case 4:return u.fn.call(u.context,t,o,n),!0;case 5:return u.fn.call(u.context,t,o,n,i),!0;case 6:return u.fn.call(u.context,t,o,n,i,s),!0}for(l=1,c=new Array(h-1);l<h;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var d,m=u.length;for(l=0;l<m;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),h){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,o);break;case 4:u[l].fn.call(u[l].context,t,o,n);break;default:if(!c)for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];u[l].fn.apply(u[l].context,c)}}return!0},EventEmitter.prototype.on=function on(e,t,r){return addListener(this,e,t,r,!1)},EventEmitter.prototype.once=function once(e,t,r){return addListener(this,e,t,r,!0)},EventEmitter.prototype.removeListener=function removeListener(e,t,o,n){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return clearEvent(this,i),this;var s=this._events[i];if(s.fn)s.fn!==t||n&&!s.once||o&&s.context!==o||clearEvent(this,i);else{for(var a=0,c=[],l=s.length;a<l;a++)(s[a].fn!==t||n&&!s[a].once||o&&s[a].context!==o)&&c.push(s[a]);c.length?this._events[i]=1===c.length?c[0]:c:clearEvent(this,i)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(e){var t;return e?(t=r?r+e:e,this._events[t]&&clearEvent(this,t)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=r,EventEmitter.EventEmitter=EventEmitter,e.exports=EventEmitter})),r=Backoff;function Backoff(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Backoff.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),r=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-r:e+r}return 0|Math.min(e,this.max)},Backoff.prototype.reset=function(){this.attempts=0},Backoff.prototype.setMin=function(e){this.ms=e},Backoff.prototype.setMax=function(e){this.max=e},Backoff.prototype.setJitter=function(e){this.jitter=e};var o="object"==typeof e&&e&&e.Object===Object&&e,n="object"==typeof self&&self&&self.Object===Object&&self,i=o||n||Function("return this")(),s=i.Symbol,a=Object.prototype,c=a.hasOwnProperty,l=a.toString,u=s?s.toStringTag:void 0;var h=function getRawTag(e){var t=c.call(e,u),r=e[u];try{e[u]=void 0;var o=!0}catch(e){}var n=l.call(e);return o&&(t?e[u]=r:delete e[u]),n},d=Object.prototype.toString;var m=function objectToString(e){return d.call(e)},p=s?s.toStringTag:void 0;var g=function baseGetTag(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":p&&p in Object(e)?h(e):m(e)};var f=function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var y=function isFunction(e){if(!f(e))return!1;var t=g(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t};const v={deviceId:"",timeout:8e3},b={account:"",appkey:"",token:"",debugLevel:"off",needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,isAbtestEnable:!0,abtestUrl:"https://abt-online.netease.im/v1/api/abt/client/getExperimentInfo",abtestProjectKey:"imElite_sdk_abtest_web"};class CustomError extends Error{constructor(e,t={},r=400){super(e),this.data=t,this.code=r,this.name="customError"}}class ValidateError extends CustomError{constructor(e,t={},r){super(e,t,414),this.code=414,this.name="validateError",this.rules=r}}const S={200:null,406:null,808:null,810:null,201:"The client version is incorrect. You need to upgrade the SDK",302:"The user name or password is incorrect. Please check whether the appkey and token are valid and whether the account and token match",403:"Illegal operation or no permission",404:"Target object does not exist",405:"Parameter length too long",408:"Client request timed out",414:"Request parameter error",415:"Service unavailable",416:"Frequency control",417:"Repeat operation",422:"Account disabled",500:"Server internal error",503:"Server busy",508:"Expiration date",509:"Invalid",7101:"Be pulled black",700:"Partial failure of batch operation",801:"The number of people in the team has reached the upper limit",802:"No permission",803:"The team does not exist or has not changed",804:"The user is not in the team",805:"Team type mismatch",806:"The number of teams created has reached the limit",807:"Team member not valid",809:"Already in the team",811:"The number of accounts in the forced push list exceeds the limit",812:"The team is muted",813:"Due to the limited number of team, some pull people successfully",814:"Disable team message read service",815:"Maximum number of team administrators",816:"Batch operation partial failure",997:"The packet has expired",998:"Deserialize packet error",999:"Serialize packet error",9102:"Channel failure",9103:"This call has been answered / rejected at another end",10201:"Signaling: target NIM client is offline",10202:"Signaling: push is unreachable",10404:"Signaling: channel not exists",10405:"Signaling: channel already exists",10406:"Signaling: member of channel not exists",10407:"Signaling: member of channel already exists",10408:"Signaling: the invitation request does not exist or has expired",10409:"Signaling: the invitation request has been rejected",10410:"Signaling: the invitation request has been accepted",10414:"Signaling: request parameter error",10417:"Signaling: uid conflict",10419:"Signaling: the number of members of channel exceed the limit",10420:"Signaling: member is already in the channel on other client",10700:"Signaling: phased success",13002:"Abnormal chatroom status",13003:"In the blacklist",13004:"In the mute list",13006:"All members are muted, and only the administrator can speak"};class CmdError extends CustomError{constructor(e,t,r="",o=(new Date).getTime(),n={}){super(r=r||S[e],n,e),this.name="cmdError",this.cmd=t,this.timetag=o}}class UploadError extends CustomError{constructor(e,t,r,o,n){super(e,{file:n},400),this.name="uploadError",this.rawError=t,this.curProvider=r||1,this.mixStorePolicy=o}}const k=["error","warn","log","debug"],emptyFunc=function(){},C=["off","error","warn","log","debug"];class Logger{constructor(e,t){this.name=t,this.strategies={debug:console.log,log:console.log,warn:console.warn,error:console.error},this.debug=emptyFunc,this.log=emptyFunc,this.warn=emptyFunc,this.error=emptyFunc,this.name=t,Logger.instancesName.push(t),C.includes(e)||(e="off"),this.setLogFunc(e)}setLogFunc(e){const t=k.findIndex((t=>t===e));k.forEach(((e,r)=>{r<=t&&(this[e]=function(){const t=Array.prototype.slice.call(arguments),r=this.formatArgs(t,e);this.strategies[e](r)})}))}formatArgs(e,t){const r=new Date,o=`${r.getMonth()+1}-${r.getDate()} ${r.getHours()}:${r.getMinutes()}:${r.getSeconds()}:${r.getMilliseconds()}`;return`[NIM ${t} ${this.name} ${o}] `+e.map((e=>e instanceof CustomError?`${e.name}, ${e.code}, ${e.message}`:e instanceof Error?e&&e.message?e.message:e:"object"==typeof e?JSON.stringify(e):e)).join(" ")}}Logger.instancesName=[];var w=createCommonjsModule((function(e,t){e.exports=function(){function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function __rest(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}var e={reportUrl:"https://statistic.live.126.net/statics/report/common/form",maxSize:100,msgListMaxSize:1e3,cacheMaxSize:1e3,maxDelay:3e5,maxInterval:3e4,minInterval:1e4,timeout:5e3,autoStart:!0},t="https://statistic.live.126.net/dispatcher/req",r=function emptyFn(){},o=function(){function Reporter(t){_classCallCheck(this,Reporter),this.enable=!1,this.initConfigLoaded=!1,this.loading=!1,this.isDestroyed=!1,this.reportConfig=e,this.msgList=[],this.traceMsgCache={},this.lowPriorityMsgList=[],this.cacheMsgList=[],this.lastReportTime=Date.now(),this.timer=null,this.setConfig(t),this.reportConfig.autoStart&&this.initUploadConfig()}return _createClass(Reporter,[{key:"setConfig",value:function setConfig(e){this.reportConfig=Object.assign({},this.reportConfig,e)}},{key:"reportImmediately",value:function reportImmediately(e,t){var r=this;this.reportConfig.request(e,Object.assign({dataType:"json",method:"POST",timeout:this.reportConfig.timeout},t)).catch((function(e){var t,o;null===(o=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===o||o.warn("Reporter immediately upload failed",e)}))}},{key:"report",value:function report(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e){var o=Date.now();r?this.lowPriorityMsgList.push({module:e,msg:t,createTime:o}):this.msgList.push({module:e,msg:t,createTime:o}),this.msgList.length>this.reportConfig.msgListMaxSize&&this.msgList.shift(),this.lowPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.lowPriorityMsgList.shift(),this.doReport()}}},{key:"reportTraceStart",value:function reportTraceStart(e,t){if(e&&!this.traceMsgCache[e]){var r=Object.assign(Object.assign({start_time:Date.now()},t),{extension:[]});this.traceMsgCache[e]=r}}},{key:"reportTraceUpdate",value:function reportTraceUpdate(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.traceMsgCache[e]){var o,n=t.operation_type,i=t.code,s=t.target,a=t.error,c=__rest(t,["operation_type","code","target","error"]),l=Date.now(),u=this.traceMsgCache[e].extension.length;o=0===u?this.traceMsgCache[e].start_time:this.traceMsgCache[e].extension[u-1].end_time,a&&a.code&&(i=a.code),this.traceMsgCache[e].extension.push({operation_type:n,code:i,succeed:r,target:s,duration:l-o,description:JSON.stringify(c),end_time:l})}}},{key:"reportTraceUpdateV2",value:function reportTraceUpdateV2(e,t){if(this.traceMsgCache[e]){var r=this.traceMsgCache[e].extension.length;t.end_time=0===r?this.traceMsgCache[e].start_time+(t.duration?t.duration:0):this.traceMsgCache[e].extension[r-1].end_time+(t.duration?t.duration:0),this.traceMsgCache[e].extension.push(t)}}},{key:"reportTraceEnd",value:function reportTraceEnd(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.traceMsgCache[e]&&("nos"!==e||!1===t?("boolean"==typeof t?this.traceMsgCache[e].succeed=!!t:this.traceMsgCache[e].state=t,this.traceMsgCache[e].duration=Date.now()-this.traceMsgCache[e].start_time,this.traceMsgCache[e].extension.forEach((function(e){delete e.end_time})),this.report(e,this.traceMsgCache[e]),this.traceMsgCache[e]=null):this.traceMsgCache[e]=null)}},{key:"pause",value:function pause(){this.enable=!1}},{key:"restore",value:function restore(){this.enable=!0,this.initConfigLoaded||this.initUploadConfig()}},{key:"destroy",value:function destroy(){var e=this;Object.keys(this.traceMsgCache).forEach((function(t){e.reportTraceEnd(t,1)})),null!==this.timer&&clearTimeout(this.timer),this.setConfig=r,this.report=r,this.reportTraceStart=r,this.reportTraceUpdate=r,this.reportTraceEnd=r,this.pause=r,this.restore=r,this.destroy=r,this.cacheMsgList=[],this.traceMsgCache={},this.lowPriorityMsgList=[],this.msgList=[],this.reportConfig={},this.isDestroyed=!0}},{key:"initUploadConfig",value:function initUploadConfig(){var e,r,o=this;if(!this.loading){this.loading=!0;var n=this.reportConfig.common||{};try{this.reportConfig.request(t,{method:"GET",dataType:"json",params:{deviceId:n.dev_id,sdkVer:n.sdk_ver,platform:n.platform,appkey:n.app_key},timeout:this.reportConfig.timeout}).then((function(e){var t,r;if(!o.isDestroyed){if(200===e.status&&e.data&&200===e.data.code){var n=e.data.data||{};o.reportConfig.maxSize=n.maxSize>1e3?1e3:n.maxSize,o.reportConfig.maxInterval=n.maxInterval>1e4?1e4:n.maxInterval,o.reportConfig.maxInterval=n.maxInterval<10?10:n.maxInterval,o.reportConfig.minInterval=n.minInterval<2?2:n.minInterval,o.reportConfig.maxDelay=n.maxDelay||300,o.reportConfig.maxInterval=1e3*o.reportConfig.maxInterval,o.reportConfig.minInterval=1e3*o.reportConfig.minInterval,o.reportConfig.maxDelay=1e3*o.reportConfig.maxDelay,o.enable=!0,o.initConfigLoaded=!0,o.loading=!1,o.reportHeartBeat()}null===(r=null===(t=o.reportConfig)||void 0===t?void 0:t.logger)||void 0===r||r.log("Get reporter upload config success")}})).catch((function(e){var t,r;o.loading=!1,null===(r=null===(t=o.reportConfig)||void 0===t?void 0:t.logger)||void 0===r||r.error("Get reporter upload config failed",e)}))}catch(t){this.loading=!1,null===(r=null===(e=this.reportConfig)||void 0===e?void 0:e.logger)||void 0===r||r.error("Exec reporter request failed",t)}}}},{key:"reportHeartBeat",value:function reportHeartBeat(){var e=this;this.isDestroyed||(this.timer=setTimeout((function(){e.reportHeartBeat()}),this.reportConfig.minInterval),this.doReport())}},{key:"doReport",value:function doReport(){if(!this.isDestroyed){var e=this.msgList.length+this.lowPriorityMsgList.length+this.cacheMsgList.length>2*this.reportConfig.maxSize?this.reportConfig.minInterval:this.reportConfig.maxInterval;Date.now()-this.lastReportTime>=e&&this.upload()}}},{key:"getUploadMsg",value:function getUploadMsg(){var e=this,t={},r=Date.now();this.msgList=this.msgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay})),this.lowPriorityMsgList=this.lowPriorityMsgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay})),this.cacheMsgList=this.cacheMsgList.filter((function(t){return r-t.createTime<e.reportConfig.maxDelay}));var o=this.msgList.slice(0,this.reportConfig.maxSize);if(this.msgList=this.msgList.slice(o.length),o.length<this.reportConfig.maxSize){var n=this.reportConfig.maxSize-o.length;o=o.concat(this.lowPriorityMsgList.slice(0,n)),this.lowPriorityMsgList=this.lowPriorityMsgList.slice(n)}if(o.length<this.reportConfig.maxSize){var i=this.reportConfig.maxSize-o.length;o=o.concat(this.cacheMsgList.slice(0,i)),this.cacheMsgList=this.cacheMsgList.slice(i)}return o.forEach((function(e){t[e.module]?t[e.module].push(e.msg):t[e.module]=[e.msg]})),{uploadMsgArr:o,uploadMsg:t}}},{key:"upload",value:function upload(){var e,t,r=this;if(this.enable&&!(this.lastReportTime&&Date.now()-this.lastReportTime<this.reportConfig.minInterval)){var o=this.getUploadMsg(),n=o.uploadMsgArr,i=o.uploadMsg;if(n.length){this.lastReportTime=Date.now();try{this.reportConfig.request(this.reportConfig.reportUrl,{dataType:"json",method:"POST",params:{common:this.reportConfig.common,event:i},headers:{sdktype:"im"},timeout:this.reportConfig.timeout}).catch((function(e){var t,o;r.cacheMsgList=r.cacheMsgList.concat(n).slice(0,r.reportConfig.cacheMaxSize),null===(o=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===o||o.warn("Reporter upload failed",e)}))}catch(r){null===(t=null===(e=this.reportConfig)||void 0===e?void 0:e.logger)||void 0===t||t.warn("Exec reporter request failed",r)}clearTimeout(this.timer),this.reportHeartBeat()}}}}]),Reporter}();return o}()}));const T={setLogger:function(e){throw new Error("Function not implemented.")},platform:"",WebSocket:class AdapterSocket{constructor(e,t){throw this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,new Error("Method not implemented.")}close(e,t){throw new Error("Method not implemented.")}send(e){throw new Error("Method not implemented.")}onclose(e){throw new Error("Method not implemented.")}onerror(e){throw new Error("Method not implemented.")}onmessage(e){throw new Error("Method not implemented.")}onopen(e){throw new Error("Method not implemented.")}},localStorage:{},request:function(e,t){throw new Error("Function not implemented.")},uploadFile:function(e){throw new Error("Function not implemented.")},getSystemInfo:function(){throw new Error("Function not implemented.")}};var M=function isUndefined(e){return void 0===e};let _={},x={};function parseCmd(e,t){var r;let o;try{o=JSON.parse(e)}catch(r){throw t.error("Parse command error: ",e),r}let n=o.sid+"_"+o.cid,i=o.r;if(["4_1","4_2","4_10","4_11"].includes(n)){const e=o.r[1].headerPacket;n=`${e.sid}_${e.cid}`,i=o.r[1].body}const s=x[n],a=_[s],c=function genCmdError(e,t){const r=S[e];return null===r?null:new CmdError(e,t,r,(new Date).getTime())}(o.code,s),l={cmd:s,raw:o,error:c,service:null==a?void 0:a.service,content:{}};if(l.error){if(l.error.cmd=s,l.error.callFunc="parseCmd",!(null===(r=null==a?void 0:a.ignoreErrCodes)||void 0===r?void 0:r.includes(o.code)))return l;t.warn("parseCmd:: ignore error ",l.error),l.error.ignore=!0}return s&&a?(a.response&&a.response.forEach(((e,t)=>{const r=i[t],o=e.type,n=e.name,s=e.reflectMapper;if(!M(r))switch(o){case"Property":l.content[n]=s?deserialize(r,s):r;break;case"PropertyArray":l.content[n]=r.map((e=>s?deserialize(e,s):e));break;case"long":case"Long":case"byte":case"Byte":case"Number":l.content[n]=+r;break;default:l.content[n]=r}})),l):(l.notFound=!0,l)}function serialize(e,t){const r={};for(const o in e)void 0!==t[o]&&(r[t[o]]=e[o]);return r}function deserialize(e,t){const r={};for(const o in e)void 0!==t[o]&&(r[t[o]]=e[o]);return r}function registerParser(e){_=Object.assign(_,e.cmdConfig),x=Object.assign(x,e.cmdMap)}function invertSerializeMap(e){return Object.keys(e).reduce(((t,r)=>{const o=e[r];return t[r]=Object.keys(o).reduce(((e,t)=>(e[o[t]]=t,e)),{}),t}),{})}const E=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],P=["transport not supported","client not handshaken","unauthorized"],O=["reconnect"];class NIMWebsocket extends t{constructor(e,t,r){super(),this.url=t,this.logger=r,this.websocket=null,this.core=e,this.url=t,this.status="disconnected",this.logger=r,this.connect()}connect(){"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this.core.adapters.request("https://"+this.url+"/socket.io/1/?t="+Date.now(),{method:"GET",dataType:"text",timeout:8e3}).then((e=>{const[t,r]=e.data.split(":");return this.sessionId=t,this.closeTimeout=1e3*r,this._createWebsocket("wss://"+this.url+"/socket.io/1/websocket/"+t)})).catch((e=>{this.logger.error("imsocket::handshake fail. ",e&&e.message),this.status="disconnected",this.emit("handshakeFailed")}))):this.logger.warn("imsocket::socket is connecting or connected",this.status)}close(){var e;if(this.websocket){this.status="disconnected",this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null;try{null===(e=this.websocket)||void 0===e||e.send(this.encodePacket({type:"disconnect"})),this.websocket.close()}catch(e){this.logger.warn("attempt to close websocket error",e)}this.websocket.onclose=null,this.websocket=null,this.emit("disconnect")}}onConnect(){this.status="connected",this.resetCloseTimer(),this.emit("connect")}_createWebsocket(e){this.websocket=new T.WebSocket(e),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onclose=()=>{this.logger.log("imsocket:: websocket onclose done"),"disconnected"!==this.status&&(this.logger.log("imsocket:: close()",this.status),this.close())},this.websocket.onerror=e=>{this.logger.error("imsocket:: onerror",e)}}onMessage(e){var t;this.resetCloseTimer();const r=this.decodePacket(e.data);if(r)switch(r.type){case"connect":this.onConnect();break;case"disconnect":this.close();break;case"message":case"json":this.emit("message",r.data);break;case"event":r.name&&this.emit(r.name,r.args);break;case"error":"unauthorized"===r.reason?this.emit("connect_failed",r.reason):this.emit("error",r.reason);break;case"heartbeat":null===(t=this.websocket)||void 0===t||t.send(this.encodePacket({type:"heartbeat"}));break;default:this.logger.warn("imsocket::no handler type",r.type)}}encodePacket(e){const{type:t,id:r="",endpoint:o="",ack:n}=e;let i,s,a=null;if(!t)return"";switch(t){case"error":i=e.reason?P.indexOf(e.reason):"",s=e.advice?O.indexOf(e.advice):"",""===i&&""===s||(a=i+(""!==s?"+"+s:""));break;case"message":""!==e.data&&(a=e.data);break;case"event":i={name:e.name},i=e.args&&e.args.length?{name:e.name,args:e.args}:{name:e.name},a=JSON.stringify(i);break;case"json":a=JSON.stringify(e.data);break;case"connect":e.qs&&(a=e.qs);break;case"ack":a=e.ackId+(e.args&&e.args.length?"+"+JSON.stringify(e.args):"")}const c=[E.indexOf(t),r+("data"===n?"+":""),o];return null!=a&&c.push(a),c.join(":")}decodePacket(e){if(!e)return;if("�"==e.charAt(0))return void this.logger.error("imsocket::unrecognize dataStr",e.slice(0,20));const t=e.match(/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/);if(!t)return;const[,r,o,n,i,s]=t,a={type:E[+r],endpoint:i};let c;switch(o&&(a.id=o,a.ack=!n||"data"),a.type){case"error":c=s.split("+"),a.reason=P[+c[0]]||"";break;case"message":a.data=s||"";break;case"connect":a.qs=s||"";break;case"event":try{const e=JSON.parse(s);a.name=e.name,a.args=e.args}catch(e){this.logger.error("imsocket::parseData::type::event error",e)}a.args=a.args||[];break;case"json":try{a.data=JSON.parse(s)}catch(e){this.logger.error("imsocket::parseData::type::json error",e)}break;case"ack":if(c=s.match(/^([0-9]+)(\+)?(.*)/),c&&(a.ackId=c[1],a.args=[],c[3]))try{a.args=c[3]?JSON.parse(c[3]):[]}catch(e){this.logger.error("imsocket::parseData::type::ack error",e)}}return a}send(e){var t;const r={data:e,type:"message",endpoint:""};null===(t=this.websocket)||void 0===t||t.send(this.encodePacket(r))}resetCloseTimer(){this.closeTimeout&&(clearTimeout(this.closeTimer),this.closeTimer=setTimeout((()=>{this.close()}),this.closeTimeout))}}var I=function isObjectLike(e){return null!=e&&"object"==typeof e};var j=function baseIsRegExp(e){return I(e)&&"[object RegExp]"==g(e)};var A,N=function baseUnary(e){return function(t){return e(t)}},L=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,i=n&&n.exports===r&&o.process,s=function(){try{var e=n&&n.require&&n.require("util").types;return e||i&&i.binding&&i.binding("util")}catch(e){}}();e.exports=s})),U=L&&L.isRegExp,D=U?N(U):j,R=i["__core-js_shared__"],$=(A=/[^.]+$/.exec(R&&R.keys&&R.keys.IE_PROTO||""))?"Symbol(src)_1."+A:"";var F=function isMasked(e){return!!$&&$ in e},q=Function.prototype.toString;var B=function toSource(e){if(null!=e){try{return q.call(e)}catch(e){}try{return e+""}catch(e){}}return""},H=/^\[object .+?Constructor\]$/,K=Function.prototype,z=Object.prototype,V=K.toString,Q=z.hasOwnProperty,G=RegExp("^"+V.call(Q).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var J=function baseIsNative(e){return!(!f(e)||F(e))&&(y(e)?G:H).test(B(e))};var W=function getValue(e,t){return null==e?void 0:e[t]};var Y=function getNative(e,t){var r=W(e,t);return J(r)?r:void 0},X=Y(Object,"create");var Z=function hashClear(){this.__data__=X?X(null):{},this.size=0};var ee=function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},te=Object.prototype.hasOwnProperty;var re=function hashGet(e){var t=this.__data__;if(X){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return te.call(t,e)?t[e]:void 0},oe=Object.prototype.hasOwnProperty;var ne=function hashHas(e){var t=this.__data__;return X?void 0!==t[e]:oe.call(t,e)};var ie=function hashSet(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=X&&void 0===t?"__lodash_hash_undefined__":t,this};function Hash(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var o=e[t];this.set(o[0],o[1])}}Hash.prototype.clear=Z,Hash.prototype.delete=ee,Hash.prototype.get=re,Hash.prototype.has=ne,Hash.prototype.set=ie;var se=Hash;var ae=function listCacheClear(){this.__data__=[],this.size=0};var ce=function eq(e,t){return e===t||e!=e&&t!=t};var le=function assocIndexOf(e,t){for(var r=e.length;r--;)if(ce(e[r][0],t))return r;return-1},ue=Array.prototype.splice;var he=function listCacheDelete(e){var t=this.__data__,r=le(t,e);return!(r<0)&&(r==t.length-1?t.pop():ue.call(t,r,1),--this.size,!0)};var de=function listCacheGet(e){var t=this.__data__,r=le(t,e);return r<0?void 0:t[r][1]};var me=function listCacheHas(e){return le(this.__data__,e)>-1};var pe=function listCacheSet(e,t){var r=this.__data__,o=le(r,e);return o<0?(++this.size,r.push([e,t])):r[o][1]=t,this};function ListCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var o=e[t];this.set(o[0],o[1])}}ListCache.prototype.clear=ae,ListCache.prototype.delete=he,ListCache.prototype.get=de,ListCache.prototype.has=me,ListCache.prototype.set=pe;var ge=ListCache,fe=Y(i,"Map");var ye=function mapCacheClear(){this.size=0,this.__data__={hash:new se,map:new(fe||ge),string:new se}};var ve=function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var be=function getMapData(e,t){var r=e.__data__;return ve(t)?r["string"==typeof t?"string":"hash"]:r.map};var Se=function mapCacheDelete(e){var t=be(this,e).delete(e);return this.size-=t?1:0,t};var ke=function mapCacheGet(e){return be(this,e).get(e)};var Ce=function mapCacheHas(e){return be(this,e).has(e)};var we=function mapCacheSet(e,t){var r=be(this,e),o=r.size;return r.set(e,t),this.size+=r.size==o?0:1,this};function MapCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var o=e[t];this.set(o[0],o[1])}}MapCache.prototype.clear=ye,MapCache.prototype.delete=Se,MapCache.prototype.get=ke,MapCache.prototype.has=Ce,MapCache.prototype.set=we;var Te=MapCache;var Me=function setCacheAdd(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this};var _e=function setCacheHas(e){return this.__data__.has(e)};function SetCache(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new Te;++t<r;)this.add(e[t])}SetCache.prototype.add=SetCache.prototype.push=Me,SetCache.prototype.has=_e;var xe=SetCache;var Ee=function baseFindIndex(e,t,r,o){for(var n=e.length,i=r+(o?1:-1);o?i--:++i<n;)if(t(e[i],i,e))return i;return-1};var Pe=function baseIsNaN(e){return e!=e};var Oe=function strictIndexOf(e,t,r){for(var o=r-1,n=e.length;++o<n;)if(e[o]===t)return o;return-1};var Ie=function baseIndexOf(e,t,r){return t==t?Oe(e,t,r):Ee(e,Pe,r)};var je=function arrayIncludes(e,t){return!!(null==e?0:e.length)&&Ie(e,t,0)>-1};var Ae=function arrayIncludesWith(e,t,r){for(var o=-1,n=null==e?0:e.length;++o<n;)if(r(t,e[o]))return!0;return!1};var Ne=function arrayMap(e,t){for(var r=-1,o=null==e?0:e.length,n=Array(o);++r<o;)n[r]=t(e[r],r,e);return n};var Le=function cacheHas(e,t){return e.has(t)};var Ue=function baseDifference(e,t,r,o){var n=-1,i=je,s=!0,a=e.length,c=[],l=t.length;if(!a)return c;r&&(t=Ne(t,N(r))),o?(i=Ae,s=!1):t.length>=200&&(i=Le,s=!1,t=new xe(t));e:for(;++n<a;){var u=e[n],h=null==r?u:r(u);if(u=o||0!==u?u:0,s&&h==h){for(var d=l;d--;)if(t[d]===h)continue e;c.push(u)}else i(t,h,o)||c.push(u)}return c};var De=function identity(e){return e};var Re=function apply(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)},$e=Math.max;var Fe=function overRest(e,t,r){return t=$e(void 0===t?e.length-1:t,0),function(){for(var o=arguments,n=-1,i=$e(o.length-t,0),s=Array(i);++n<i;)s[n]=o[t+n];n=-1;for(var a=Array(t+1);++n<t;)a[n]=o[n];return a[t]=r(s),Re(e,this,a)}};var qe=function constant(e){return function(){return e}},Be=function(){try{var e=Y(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),He=Be?function(e,t){return Be(e,"toString",{configurable:!0,enumerable:!1,value:qe(t),writable:!0})}:De,Ke=Date.now;var ze=function shortOut(e){var t=0,r=0;return function(){var o=Ke(),n=16-(o-r);if(r=o,n>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}},Ve=ze(He);var Qe=function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var Ge=function isArrayLike(e){return null!=e&&Qe(e.length)&&!y(e)};var Je=function isArrayLikeObject(e){return I(e)&&Ge(e)},We=function baseRest(e,t){return Ve(Fe(e,t,De),e+"")}((function(e,t){return Je(e)?Ue(e,t):[]}));function replacer(e,t){return t instanceof RegExp?"__REGEXP "+t.toString():t}function validate(e,t={},r){const o={};return Object.keys(e).forEach((n=>{const i=e[n].type,s=r?`In ${r}, `:"";if(void 0===t[n]){if(!1===e[n].required)return void(o[n]=t[n]);throw new ValidateError(`${s}param "${n}" is required`,{key:n},"required")}const a=Ye[i];if(a&&!a(t,n,e[n]))throw new ValidateError(`${s}param "${n}" expects ${JSON.stringify(e[n],replacer)}`,{key:n,value:t[n]},JSON.stringify(e[n]));o[n]=t[n]})),o}const Ye={string:function(e,t,r){const{allowEmpty:o,max:n,min:i,regExp:s}=r,a=e[t];return"string"==typeof a&&((!1!==o||""!==a)&&(!("number"==typeof n&&a.length>n)&&(!("number"==typeof i&&a.length<i)&&!(D(s)&&!s.test(a)))))},number:function(e,t,r){const{min:o,max:n}=r,i=e[t];return"number"==typeof i&&(!("number"==typeof o&&i<o)&&!("number"==typeof n&&i>n))},boolean:function(e,t){return"boolean"==typeof e[t]},enum:function(e,t,r){const{values:o}=r,n=e[t];return!o||o.indexOf(n)>-1},array:function(e,t,r){const{itemType:o,rules:n,min:i,max:s,values:a}=r,c=e[t];return!!Array.isArray(c)&&(!("number"==typeof s&&c.length>s)&&(!("number"==typeof i&&c.length<i)&&(!(o&&"enum"!==o&&!c.every((e=>typeof e===o)))&&(("enum"!==o||!a||!We(c,...a).length)&&(n&&c.forEach(((e,r)=>validate(n,e,`${t}[${r}]`))),!0)))))},object:function(e,t,r){const{rules:o}=r,n=e[t];return o&&validate(o,n,t),!0}};var Xe=Y(i,"Set");var Ze=function noop(){};var et=function setToArray(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r},rt=Xe&&1/et(new Xe([,-0]))[1]==1/0?function(e){return new Xe(e)}:Ze;var ot=function baseUniq(e,t,r){var o=-1,n=je,i=e.length,s=!0,a=[],c=a;if(r)s=!1,n=Ae;else if(i>=200){var l=t?null:rt(e);if(l)return et(l);s=!1,n=Le,c=new xe}else c=t?[]:a;e:for(;++o<i;){var u=e[o],h=t?t(u):u;if(u=r||0!==u?u:0,s&&h==h){for(var d=c.length;d--;)if(c[d]===h)continue e;t&&c.push(h),a.push(u)}else n(c,h,r)||(c!==a&&c.push(h),a.push(u))}return a};var nt=function uniq(e){return e&&e.length?ot(e):[]};const it=function(){const _s4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return function(){return _s4()+_s4()+_s4()+_s4()+_s4()+_s4()+_s4()+_s4()}}();function getEnumKeys(e){return Object.keys(e).filter((e=>!(+e>=0)))}function getEnumKeyByEnumValue(e,t){const r=Object.keys(e).filter((r=>e[r]==t));return r.length>0?r[0]:void 0}class TimerManager{constructor(){this.timerList=[],this.id=0,this.timer=null,this.timeout=0}addTimer(e,t=0,r=1){const o=(new Date).getTime(),n=this.id;return this.timerList.push({id:n,loop:r,count:0,timeout:o+t,interval:t,callback:e}),this.id++,this.checkTimer(o),n}checkTimer(e=(new Date).getTime()){if(this.removeFinished(),0===this.timerList.length&&null!=this.timer)return;let t=0;for(const e of this.timerList)(0===t||t>e.timeout)&&(t=e.timeout);0!==this.timerList.length&&(null===this.timer||t<this.timeout||this.timeout<e)&&(this.timer=setTimeout(this.nowTime.bind(this),t-e),this.timeout=t)}nowTime(){const e=(new Date).getTime();for(const t of this.timerList)e>=t.timeout&&(t.callback(),t.count++,t.timeout=e+t.interval);this.clerTime(),this.checkTimer(e)}clerTime(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)}deleteTimer(e){for(let t=this.timerList.length-1;t>=0;t--){this.timerList[t].id===e&&this.timerList.splice(t,1)}}removeFinished(){for(let e=this.timerList.length-1;e>=0;e--){const t=this.timerList[e];t.loop>=0&&t.count>=t.loop&&this.timerList.splice(e,1)}}destroy(){this.clerTime(),this.timerList=[],this.id=0,this.timer=null}}class CoreAdapters{constructor(e){this.core=e}request(e,t){const r=(new Date).getTime();return T.request(e,t).catch((o=>{var n,i;const s=o;throw this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(i=null===(n=this.core)||void 0===n?void 0:n.socket)||void 0===i?void 0:i.sessionId,start_time:r,action:1}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof s.code?s.code:0,description:s.message||`${s.code}`,operation_type:0,target:e,context:t?JSON.stringify(t):""}),this.core.reporter.reportTraceEnd("exceptions",1),o}))}uploadFile(e){const t=(new Date).getTime();return T.uploadFile(e).catch((r=>{var o,n;const i=r;this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(n=null===(o=this.core)||void 0===o?void 0:o.socket)||void 0===n?void 0:n.sessionId,start_time:t,action:1});const s="BROWSER"===T.platform?e.chunkUploadHost:e.commonUploadHost?`${e.commonUploadHost}/${e.nosToken&&e.nosToken.bucket}`:"https://nos.netease.com/nim";throw this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof i.code?i.code:0,description:i.message||`${i.code}`,operation_type:1,target:s}),this.core.reporter.reportTraceEnd("exceptions",1),r}))}}var st;!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(st||(st={}));const at=window&&y(window.addEventListener)&&y(window.removeEventListener);class Core extends t{constructor(e,o){super(),this.status="unconnected",this.linkUrls=[],this.eventBus=new t,this.packetSer=1,this.retryCount=0,this.reconnectTimer=0,this.backoff=new r({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new Map,this.pingTimer=0,this.config=v,this.abtInfo={},validate({linkUrls:{type:"array",itemType:"string",required:!1}},e),this.options=Object.assign(Object.assign({},b),e),this.adapters=new CoreAdapters(this);let n=T.localStorage.getItem("__NIM_DEVC_ID__");this.options.isFixedDeviceId?(n=T.localStorage.getItem("__NIM_DEVC_ID__")||it(),T.localStorage.setItem("__NIM_DEVC_ID__",n)):n=it(),this.config=Object.assign(Object.assign(Object.assign({},v),o),{deviceId:n}),this.timerManager=new TimerManager,this.logger=new Logger(this.options.debugLevel,this.options.account);const i=T.getSystemInfo();this.reporter=new w({common:{app_key:e.appkey,dev_id:n,platform:"Web",sdk_ver:"0.12.3",env:"online",os_name:i.os,os_ver:i.osVer,host_env:i.hostEnv,host_info:i.hostInfo,host_env_ver:i.hostEnvVer},request:T.request,logger:this.logger,autoStart:"BROWSER"===T.platform}),T.setLogger(this.logger),this.logger.log("Core init, version ","0.12.3"," sdk version ",90903," appkey ",e.appkey)}connect(e={}){return __awaiter(this,void 0,void 0,(function*(){if(validate({linkUrls:{type:"array",itemType:"string",required:!1}},e),!/^(unconnected|waitReconnect)$/.test(this.status)){const e=`Core socket status is ${this.status}, and would not connect`;return this.logger.warn(e),Promise.reject(e)}this.status="connecting",e.linkUrls&&e.linkUrls.length>0&&(this.linkUrls=e.linkUrls.concat(this.linkUrls),this.linkUrls=nt(this.linkUrls)),0===this.linkUrls.length&&this.linkUrls.push("weblink.netease.im:443");for(let e=0;e<this.linkUrls.length;e++){const t=this.linkUrls[e],r=(new Date).getTime();try{return yield this.doConnect(t),this.reporter.reportTraceUpdate("login",{operation_type:"TCP",target:t}),this.status="connected",this.logger.log(`core:: connect success with url: ${t}`),this.abtRequest(),t}catch(e){const o=e;this.reporter.reportTraceUpdate("login",{operation_type:"TCP",error:"ws_handshake_failed",target:t},!1),this.reporter.reportTraceStart("exceptions",{user_id:this.options.account,start_time:r,action:0}),this.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof o.code?o.code:0,description:o.message||`${o.code}`,operation_type:0,target:t}),this.reporter.reportTraceEnd("exceptions",1),this.logger.warn(`core:: connect failed with url: ${t}`,e)}}throw this.reporter.reportTraceEnd("login",!1),0===this.retryCount?this.doDisconnect(st.ACTIVE,"SocketHandshakeFailed"):this.doDisconnect(st.OFFLINE,"ReconnectHadRetryAllLinks"),new Error("core: socket handshake failed")}))}doConnect(e){return new Promise(((t,r)=>{this.socket=new NIMWebsocket(this,e,this.logger),this.socket.on("connect",(()=>{this.logger.log("socket on connect",e),t()})),this.socket.on("message",this.onMessage.bind(this)),this.socket.on("disconnect",(e=>{this.logger.log("core:: socket on disconnect",e),this.doDisconnect(st.OFFLINE,"SocketOnDisconnect")})),this.socket.on("handshakeFailed",(()=>{this.logger.warn("core:: socket handshake failed"),r(new CustomError("handshake failed",{},408))}))}))}resetConnectStatus(){clearTimeout(this.reconnectTimer),this.backoff.reset(),this.retryCount=0,this.initOnlineListener()}doDisconnect(e,t){if(this.logger.log(`doDisconnect: type ${e}, description ${t}`),"unconnected"===this.status)return void this.logger.warn("doDisconnect: already unconnected");this.markAllCmdInvaild(new CustomError("Packet timeout due to instance disconnect",{},408)),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0);const r=!this.options.needReconnect||this.retryCount>=this.options.reconnectionAttempts;if(e===st.ACTIVE||r)this.logger.log("doDisconnect: emit disconnect, type "+e,r),this.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.eventBus.emit("disconnect"),this.emit("disconnect"),this.destroyOnlineListener();else if(e===st.KICKED){this.logger.log("doDisconnect: kicked"),this.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer);const e="string"==typeof t?{reason:"unknow",message:t}:t;this.eventBus.emit("kicked",e),this.emit("kicked",e),this.destroyOnlineListener()}else e===st.OFFLINE?(this.logger.log("doDisconnect: start to reconnect"),this.attempToReconnect()):this.logger.log("doDisconnect: nothing to do")}attempToReconnect(){if("waitReconnect"===this.status)return void this.logger.warn("doDisconnect: already is waiting reconnect");const e=this.backoff.duration();this.retryCount++,this.logger.log(`willReconnect ${this.retryCount} ${e}`),this.eventBus.emit("willReconnect",{retryCount:this.retryCount,duration:e}),this.emit("willReconnect",{retryCount:this.retryCount,duration:e}),this.status="waitReconnect",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout((()=>{"waitReconnect"===this.status?this.connect({isAutoReconnect:!0}).catch((()=>{this.logger.error(`core::attempToReconnect failed ${this.retryCount}`)})):this.logger.warn(`doDisconnect: reconnectTimer status is ${this.status}, would not go on reconnecting`)}),e)}sendCmd(e,t,r){if("logined"!==this.status&&"login"!==e&&"chatroomLogin"!==e&&"qchatLogin"!==e)return this.logger.warn(`nim status is ${this.status}, so can not sendCmd ${e}`),Promise.reject({cmd:e,error:{code:"No_connected",message:"Connection not established",timetag:(new Date).getTime()}});if(!this.socket||!this.socket.send)return Promise.reject("No_socket");const o="heartbeat"!==e,n=o?this.packetSer++:0,i=function createCmd(e,t,r,o){const n=_[e];if(!n)return r.error("createCmd:: can not find cmd config: ",e),null;const i={SER:t,SID:n.sid,CID:n.cid,Q:[]};return n.params&&o&&n.params.forEach((function(e){let t=o[e.name];if(M(t))return;let r=e.type;const{reflectMapper:n}=e;switch(e.type){case"PropertyArray":r="ArrayMable",t=t.map((e=>({t:"Property",v:n?serialize(e,n):e})));break;case"Property":t=n?serialize(t,n):t;break;case"Bool":case"bool":t=t?"true":"false"}i.Q.push({t:r,v:t})})),{packet:i,isNoResponse:n.isNoResponse||!1}}(e,n,this.logger,t);if(!i){const t=`SendCmd ${n} ${e} error`;return this.logger.error(t),Promise.reject(t)}const{packet:s,isNoResponse:a}=i,c=JSON.stringify(s);o&&("debug"===this.options.debugLevel?this.logger.debug("core::sendCmd",e,`ser:${n}`,c):this.logger.log("core::sendCmd",e,`ser:${n}`));const l=(new Date).getTime();return new Promise(((o,i)=>{this.sendingCmdMap.set(n,{cmd:e,params:t,callback:[o,i],timer:a?null:setTimeout((()=>{var t;const r=new CmdError(504,e,"Packet Timeout",(new Date).getTime(),{message:`ser ${n} cmd ${e} timeout`});r.callFunc="sendCmd",this.markCmdInvalid(n,r,e),this.reporter.reportTraceStart("exceptions",{user_id:this.options.account,trace_id:null===(t=this.socket)||void 0===t?void 0:t.sessionId,start_time:l,action:2}),this.reporter.reportTraceUpdateV2("exceptions",{code:408,description:"Packet timeout",operation_type:1,target:`${s.SID}-${s.CID}`,context:`${s.SER}`}),this.reporter.reportTraceEnd("exceptions",1)}),r&&r.timeout?r.timeout:this.config.timeout)});try{this.socket.send(c)}catch(t){const r=new CmdError(415,e,t&&t.message||"Unable to send packet",(new Date).getTime(),{message:"send json error",rawError:t});r.callFunc="sendCmd",this.markCmdInvalid(n,r,e),i(t)}}))}onMessage(e){const t=parseCmd(e,this.logger);if(!t)return;const r=t.raw.ser;if(t.error&&this.logger.error("core:onMessage packet error",`${t.raw.sid}_${t.raw.cid}, ser:${r},`,t.error),!t.notFound)return"heartbeat"!==t.cmd&&("debug"===this.options.debugLevel?this.logger.debug(`imsocket::recvCmd ser:${r}`,t.cmd,t.content):this.logger.log(`imsocket::recvCmd ser:${r}`,t.cmd)),t.__receiveTime=Date.now(),t;this.logger.warn("core::onMessage packet not found",`${t.raw.sid}_${t.raw.cid}, ser:${r}`)}markCmdInvalid(e,t,r){const o=this.sendingCmdMap.get(e);if(!o)return;const{callback:n,timer:i}=o;i&&clearTimeout(i),this.sendingCmdMap.delete(e),this.logger.warn(`packet ${e}, ${r} is invalid:`,t),n[1](t)}markAllCmdInvaild(e){this.logger.log("markAllCmdInvaild"),this.sendingCmdMap.forEach((t=>{const{callback:r,timer:o}=t;o&&clearTimeout(o),r[1](e)})),this.sendingCmdMap.clear()}ping(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);try{yield this.sendCmd("heartbeat")}catch(e){if(yield this.testHeartBeat5Timeout())return void this.doDisconnect(st.OFFLINE,"PingError")}this.pingTimer=setTimeout((()=>{this.ping()}),3e4)}))}testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,(function*(){clearTimeout(this.pingTimer);for(let e=0;e<5;e++)try{return yield this.sendCmd("heartbeat",{},{timeout:3e3}),!1}catch(t){this.logger.debug(`core:: test heartbeat ${e} Timeout`)}return!0}))}initOnlineListener(){this.onlineListener||(at?(this.onlineListener=function(){"logined"===this.status&&this.ping()}.bind(this),this.offlineListener=function(){this.logger.log("offline"),this.doDisconnect(st.OFFLINE,"OfflineListener")}.bind(this),window.addEventListener("online",this.onlineListener),window.addEventListener("offline",this.offlineListener)):this.logger.warn("initOnlineListener not support add listener"))}destroyOnlineListener(){this.onlineListener&&(window.removeEventListener("online",this.onlineListener),this.onlineListener=void 0),this.offlineListener&&(window.removeEventListener("offline",this.offlineListener),this.offlineListener=void 0)}disconnect(){switch(this.status){case"connected":case"logined":case"connecting":case"waitReconnect":return this.doDisconnect(st.ACTIVE,"UserActiveDisconnect"),Promise.resolve();case"unconnected":case"destroyed":return Promise.resolve()}}destroy(){return this.disconnect().then((()=>{this.status="destroyed",this.removeAllListeners(),this.eventBus.removeAllListeners(),this.reporter.destroy(),this.connect=()=>Promise.resolve(),this.disconnect=()=>Promise.resolve(),this.destroy=()=>Promise.resolve()}))}abtRequest(){var e,t;return __awaiter(this,void 0,void 0,(function*(){if(!this.options.isAbtestEnable)return;if(this.abtInfo.experiments)return;if(!this.options.abtestUrl)return;let r;try{r=yield this.adapters.request(this.options.abtestUrl,{method:"POST",dataType:"json",headers:{sdktype:"ABTest"},params:{clientInfo:{projectKey:this.options.abtestProjectKey,appKey:this.options.appkey,osType:"Web",sdkVersion:"0.12.3",deviceId:this.config.deviceId},useLocalCache:!0}})}catch(e){this.logger.warn("ABTest request failed")}this.abtInfo=(null===(t=null===(e=null==r?void 0:r.data)||void 0===e?void 0:e.data)||void 0===t?void 0:t.abtInfo)||{},this.abtInfo.experiments&&this.abtInfo.experiments.length>0&&this.reporter.reportImmediately("https://statistic.live.126.net/statics/report/abtest/result",{params:{app_key:this.options.appkey,biz_sdk_type:"IM",sdk_ver:"0.12.3",device_id:this.config.deviceId,platform:"Web",projectKey:this.options.abtestProjectKey,experiments:this.abtInfo.experiments.map((e=>({experimentKey:e.experimentKey,schemeKey:e.schemeKey})))},headers:{sdktype:"ABTest"},method:"POST",dataType:"json"})}))}}Core.setAdapters=function setAdapters(e){Object.assign(T,e)};var ct=function createBaseFor(e){return function(t,r,o){for(var n=-1,i=Object(t),s=o(t),a=s.length;a--;){var c=s[e?a:++n];if(!1===r(i[c],c,i))break}return t}}();var lt=function baseTimes(e,t){for(var r=-1,o=Array(e);++r<e;)o[r]=t(r);return o};var ut=function baseIsArguments(e){return I(e)&&"[object Arguments]"==g(e)},ht=Object.prototype,dt=ht.hasOwnProperty,mt=ht.propertyIsEnumerable,pt=ut(function(){return arguments}())?ut:function(e){return I(e)&&dt.call(e,"callee")&&!mt.call(e,"callee")},gt=pt,ft=Array.isArray;var yt=function stubFalse(){return!1},vt=createCommonjsModule((function(e,t){var r=t&&!t.nodeType&&t,o=r&&e&&!e.nodeType&&e,n=o&&o.exports===r?i.Buffer:void 0,s=(n?n.isBuffer:void 0)||yt;e.exports=s})),bt=/^(?:0|[1-9]\d*)$/;var St=function isIndex(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&bt.test(e))&&e>-1&&e%1==0&&e<t},kt={};kt["[object Float32Array]"]=kt["[object Float64Array]"]=kt["[object Int8Array]"]=kt["[object Int16Array]"]=kt["[object Int32Array]"]=kt["[object Uint8Array]"]=kt["[object Uint8ClampedArray]"]=kt["[object Uint16Array]"]=kt["[object Uint32Array]"]=!0,kt["[object Arguments]"]=kt["[object Array]"]=kt["[object ArrayBuffer]"]=kt["[object Boolean]"]=kt["[object DataView]"]=kt["[object Date]"]=kt["[object Error]"]=kt["[object Function]"]=kt["[object Map]"]=kt["[object Number]"]=kt["[object Object]"]=kt["[object RegExp]"]=kt["[object Set]"]=kt["[object String]"]=kt["[object WeakMap]"]=!1;var Ct=function baseIsTypedArray(e){return I(e)&&Qe(e.length)&&!!kt[g(e)]},wt=L&&L.isTypedArray,Tt=wt?N(wt):Ct,Mt=Object.prototype.hasOwnProperty;var _t=function arrayLikeKeys(e,t){var r=ft(e),o=!r&&gt(e),n=!r&&!o&&vt(e),i=!r&&!o&&!n&&Tt(e),s=r||o||n||i,a=s?lt(e.length,String):[],c=a.length;for(var l in e)!t&&!Mt.call(e,l)||s&&("length"==l||n&&("offset"==l||"parent"==l)||i&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||St(l,c))||a.push(l);return a},xt=Object.prototype;var Et=function isPrototype(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||xt)};var Pt=function overArg(e,t){return function(r){return e(t(r))}},Ot=Pt(Object.keys,Object),It=Object.prototype.hasOwnProperty;var jt=function baseKeys(e){if(!Et(e))return Ot(e);var t=[];for(var r in Object(e))It.call(e,r)&&"constructor"!=r&&t.push(r);return t};var At=function keys(e){return Ge(e)?_t(e):jt(e)};var Nt=function baseForOwn(e,t){return e&&ct(e,t,At)};var Lt=function baseInverter(e,t,r,o){return Nt(e,(function(e,n,i){t(o,r(e),n,i)})),o};var Ut,Dt,Rt=function createInverter(e,t){return function(r,o){return Lt(r,e,t(o),{})}},$t=Object.prototype.toString,Ft=Rt((function(e,t,r){null!=t&&"function"!=typeof t.toString&&(t=$t.call(t)),e[t]=r}),qe(De));function formatChatroom(e){const t=Object.assign({},e);return["announcement","broadcastUrl","ext"].forEach((e=>{void 0===t[e]&&(t[e]="")})),["createTime","updateTime","onlineMemberNum"].forEach((e=>{void 0!==t[e]&&(t[e]=parseInt(t[e]))})),["mute"].forEach((e=>{void 0!==t[e]&&(t[e]=1===parseInt(t[e]))})),t}!function(e){e[e.Android=1]="Android",e[e.iOS=2]="iOS",e[e.PC=4]="PC",e[e.WindowsPhone=8]="WindowsPhone",e[e.Web=16]="Web",e[e.Server=32]="Server",e[e.Mac=64]="Mac"}(Ut||(Ut={})),function(e){e[e.text=0]="text",e[e.image=1]="image",e[e.audio=2]="audio",e[e.video=3]="video",e[e.geo=4]="geo",e[e.notification=5]="notification",e[e.file=6]="file",e[e.tip=10]="tip",e[e.robot=11]="robot",e[e.g2=12]="g2",e[e.custom=100]="custom"}(Dt||(Dt={}));const qt=Ft({unset:"-2",restricted:"-1",common:"0",owner:"1",manager:"2",guest:"3",anonymous:"4"});function formatChatroomMember(e){const t=Object.assign({},e),r={tempMuted:!1,tempMuteDuration:0};return Object.keys(r).forEach((e=>{t[e]=t[e]||r[e]})),["chatroomId"].forEach((e=>{void 0!==t[e]&&(t[e]=t[e].toString())})),["level","enterTime","updateTime","tempMuteDuration"].forEach((e=>{void 0!==t[e]&&(t[e]=parseInt(t[e]))})),["online","guest","blacked","muted","valid","tempMuted"].forEach((e=>{void 0!==t[e]&&(t[e]=1===parseInt(t[e]))})),void 0!==t.type&&(t.type=qt[t.type]),t.avatar,t.online||delete t.enterTime,t.guest&&(t.type="guest",delete t.valid,delete t.guest),"common"!==t.type&&delete t.level,t}function formatChatroomMembers(e){return e&&e.length>0?e.map((e=>formatChatroomMember(e))):[]}const Bt={301:"memberEnter",302:"memberExit",303:"blackMember",304:"unblackMember",305:"gagMember",306:"ungagMember",307:"addManager",308:"removeManager",309:"addCommon",310:"removeCommon",311:"closeChatroom",312:"updateChatroom",313:"kickMember",314:"addTempMute",315:"removeTempMute",316:"updateMemberInfo",317:"updateQueue",318:"muteRoom",319:"unmuteRoom",320:"batchUpdateQueue",321:"addTempMuteTag",322:"removeTempMuteTag",323:"deleteChatroomMsg",325:"updateChatroomTags"};function formatChatroomMsg(e,t){const r=__rest(e,["onUploadDone","onUploadProgress","onUploadStart"]);if(["time","userUpdateTime"].forEach((e=>{void 0!==r[e]&&(r[e]=parseInt(r[e]))})),["resend","needAntiSpam","antiSpamUsingYidun","skipHistory","highPriority","clientAntiSpam"].forEach((e=>{void 0!==r[e]&&(r[e]=1===parseInt(r[e]))})),r.type=getEnumKeyByEnumValue(Dt,r.type),r.fromClientType=getEnumKeyByEnumValue(Ut,r.fromClientType),r.flow=r.from===t?"out":"in",r.status=r.status||"success","string"==typeof r.body)try{r.body=JSON.parse(r.body)}catch(e){}return"notification"===r.type&&(r.attach=r.body?function formatNotificationBody(e){let t={};if(t.type=Bt[e.id]||e.id,!e.data)return e;t=Object.assign(t,e.data);const r={operator:"from",opeNick:"fromNick",target:"to",tarNick:"toNick"};if(Object.keys(r).forEach((e=>{void 0!==t[e]&&(t[r[e]]=t[e],delete t[e])})),["muteDuration"].forEach((e=>{void 0!==t[e]&&(t[e]=parseInt(t[e]))})),!t.queueChange)return t;let o={};try{o=JSON.parse(t.queueChange)}catch(e){return t}switch(o._e){case"OFFER":o={type:"OFFER",elementKey:o.key,elementValue:o.content};break;case"POLL":o={type:"POLL",elementKey:o.key,elementValue:o.content};break;case"DROP":o={type:"DROP"};break;case"PARTCLEAR":case"BATCH_UPDATE":o={type:o._e,elementKv:o.kvObject}}return t.queueChange=o,t}(r.body):{},r.body=""),r}function formatChatroomMsgs(e,t){return e&&e.length>0?e.map((e=>formatChatroomMsg(e,t))):[]}const Ht={1:{code:"chatroomClosed",message:"Chatroom is closed"},2:{code:"managerKick",message:"Kicked out by owners or administrators"},3:{code:"samePlatformKick",message:"The same account is not allowed to multiple login at the same time"},4:{code:"silentlyKick",message:"Quietly kicked"},5:{code:"blacked",message:"Was blacklisted"}};class Service{constructor(e,t){this.name=e,this.core=t,this.name=e,this.logger=t.logger,this.core=t}process(e){const t=this[e.cmd+"Handler"];return"function"==typeof t?t.call(this,e):e.error&&!e.error.ignore?Promise.reject(e.error):Promise.resolve(e)}}class ChatroomService extends Service{constructor(e){super("chatroom",e)}getInfo(){var e;return __awaiter(this,void 0,void 0,(function*(){const t=yield this.core.sendCmd("getChatroom");return formatChatroom(null===(e=t.content)||void 0===e?void 0:e.chatroom)}))}updateInfo(e){return __awaiter(this,void 0,void 0,(function*(){validate({chatroom:{type:"object",rules:{name:{type:"string",required:!1},announcement:{type:"string",required:!1},broadcastUrl:{type:"string",required:!1},ext:{type:"string",required:!1},queuelevel:{type:"number",min:0,max:1,required:!1}}},needNotify:{type:"boolean"},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("updateChatroom",Object.assign(Object.assign({},e),{ext:e.ext||""}))}))}beKickedFromChatroomHandler(e){const t=e.content,{reason:r,ext:o}=t,n=function formatKickedReason(e){const t=Ht[e];return{reason:t?t.code:"unknow",message:t?t.message:"Unknown reason"}}(r);this.logger.warn("beKickedFromChatroomHandler:: ",n.reason,n.message,o),this.core.doDisconnect(st.KICKED,n)}updateChatroomTagHandler(e){var t;const r=e.content;this.logger.log("updateChatroomTagHandler:: ",r);let o=null===(t=null==r?void 0:r.updateTags)||void 0===t?void 0:t.currentTags;try{o=JSON.parse(o)}catch(e){this.logger.error("updateChatroomTagHandler:: ",e)}this.core.emit("tagsUpdate",o)}}var Kt=function stackClear(){this.__data__=new ge,this.size=0};var zt=function stackDelete(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r};var Vt=function stackGet(e){return this.__data__.get(e)};var Qt=function stackHas(e){return this.__data__.has(e)};var Gt=function stackSet(e,t){var r=this.__data__;if(r instanceof ge){var o=r.__data__;if(!fe||o.length<199)return o.push([e,t]),this.size=++r.size,this;r=this.__data__=new Te(o)}return r.set(e,t),this.size=r.size,this};function Stack(e){var t=this.__data__=new ge(e);this.size=t.size}Stack.prototype.clear=Kt,Stack.prototype.delete=zt,Stack.prototype.get=Vt,Stack.prototype.has=Qt,Stack.prototype.set=Gt;var Jt=Stack;var Wt=function arraySome(e,t){for(var r=-1,o=null==e?0:e.length;++r<o;)if(t(e[r],r,e))return!0;return!1};var Yt=function equalArrays(e,t,r,o,n,i){var s=1&r,a=e.length,c=t.length;if(a!=c&&!(s&&c>a))return!1;var l=i.get(e),u=i.get(t);if(l&&u)return l==t&&u==e;var h=-1,d=!0,m=2&r?new xe:void 0;for(i.set(e,t),i.set(t,e);++h<a;){var p=e[h],g=t[h];if(o)var f=s?o(g,p,h,t,e,i):o(p,g,h,e,t,i);if(void 0!==f){if(f)continue;d=!1;break}if(m){if(!Wt(t,(function(e,t){if(!Le(m,t)&&(p===e||n(p,e,r,o,i)))return m.push(t)}))){d=!1;break}}else if(p!==g&&!n(p,g,r,o,i)){d=!1;break}}return i.delete(e),i.delete(t),d},Xt=i.Uint8Array;var Zt=function mapToArray(e){var t=-1,r=Array(e.size);return e.forEach((function(e,o){r[++t]=[o,e]})),r},er=s?s.prototype:void 0,tr=er?er.valueOf:void 0;var rr=function equalByTag(e,t,r,o,n,i,s){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!i(new Xt(e),new Xt(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return ce(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var a=Zt;case"[object Set]":var c=1&o;if(a||(a=et),e.size!=t.size&&!c)return!1;var l=s.get(e);if(l)return l==t;o|=2,s.set(e,t);var u=Yt(a(e),a(t),o,n,i,s);return s.delete(e),u;case"[object Symbol]":if(tr)return tr.call(e)==tr.call(t)}return!1};var or=function arrayPush(e,t){for(var r=-1,o=t.length,n=e.length;++r<o;)e[n+r]=t[r];return e};var nr=function baseGetAllKeys(e,t,r){var o=t(e);return ft(e)?o:or(o,r(e))};var ir=function arrayFilter(e,t){for(var r=-1,o=null==e?0:e.length,n=0,i=[];++r<o;){var s=e[r];t(s,r,e)&&(i[n++]=s)}return i};var sr=function stubArray(){return[]},ar=Object.prototype.propertyIsEnumerable,cr=Object.getOwnPropertySymbols,lr=cr?function(e){return null==e?[]:(e=Object(e),ir(cr(e),(function(t){return ar.call(e,t)})))}:sr;var ur=function getAllKeys(e){return nr(e,At,lr)},hr=Object.prototype.hasOwnProperty;var dr=function equalObjects(e,t,r,o,n,i){var s=1&r,a=ur(e),c=a.length;if(c!=ur(t).length&&!s)return!1;for(var l=c;l--;){var u=a[l];if(!(s?u in t:hr.call(t,u)))return!1}var h=i.get(e),d=i.get(t);if(h&&d)return h==t&&d==e;var m=!0;i.set(e,t),i.set(t,e);for(var p=s;++l<c;){var g=e[u=a[l]],f=t[u];if(o)var y=s?o(f,g,u,t,e,i):o(g,f,u,e,t,i);if(!(void 0===y?g===f||n(g,f,r,o,i):y)){m=!1;break}p||(p="constructor"==u)}if(m&&!p){var v=e.constructor,b=t.constructor;v==b||!("constructor"in e)||!("constructor"in t)||"function"==typeof v&&v instanceof v&&"function"==typeof b&&b instanceof b||(m=!1)}return i.delete(e),i.delete(t),m},mr=Y(i,"DataView"),pr=Y(i,"Promise"),gr=Y(i,"WeakMap"),fr="[object Map]",yr="[object Promise]",vr="[object Set]",br="[object WeakMap]",Sr="[object DataView]",kr=B(mr),Cr=B(fe),wr=B(pr),Tr=B(Xe),Mr=B(gr),_r=g;(mr&&_r(new mr(new ArrayBuffer(1)))!=Sr||fe&&_r(new fe)!=fr||pr&&_r(pr.resolve())!=yr||Xe&&_r(new Xe)!=vr||gr&&_r(new gr)!=br)&&(_r=function(e){var t=g(e),r="[object Object]"==t?e.constructor:void 0,o=r?B(r):"";if(o)switch(o){case kr:return Sr;case Cr:return fr;case wr:return yr;case Tr:return vr;case Mr:return br}return t});var xr=_r,Er="[object Arguments]",Pr="[object Array]",Or="[object Object]",Ir=Object.prototype.hasOwnProperty;var jr=function baseIsEqualDeep(e,t,r,o,n,i){var s=ft(e),a=ft(t),c=s?Pr:xr(e),l=a?Pr:xr(t),u=(c=c==Er?Or:c)==Or,h=(l=l==Er?Or:l)==Or,d=c==l;if(d&&vt(e)){if(!vt(t))return!1;s=!0,u=!1}if(d&&!u)return i||(i=new Jt),s||Tt(e)?Yt(e,t,r,o,n,i):rr(e,t,c,r,o,n,i);if(!(1&r)){var m=u&&Ir.call(e,"__wrapped__"),p=h&&Ir.call(t,"__wrapped__");if(m||p){var g=m?e.value():e,f=p?t.value():t;return i||(i=new Jt),n(g,f,r,o,i)}}return!!d&&(i||(i=new Jt),dr(e,t,r,o,n,i))};var Ar=function baseIsEqual(e,t,r,o,n){return e===t||(null==e||null==t||!I(e)&&!I(t)?e!=e&&t!=t:jr(e,t,r,o,baseIsEqual,n))};var Nr=function baseIsMatch(e,t,r,o){var n=r.length,i=n,s=!o;if(null==e)return!i;for(e=Object(e);n--;){var a=r[n];if(s&&a[2]?a[1]!==e[a[0]]:!(a[0]in e))return!1}for(;++n<i;){var c=(a=r[n])[0],l=e[c],u=a[1];if(s&&a[2]){if(void 0===l&&!(c in e))return!1}else{var h=new Jt;if(o)var d=o(l,u,c,e,t,h);if(!(void 0===d?Ar(u,l,3,o,h):d))return!1}}return!0};var Lr=function isStrictComparable(e){return e==e&&!f(e)};var Ur=function getMatchData(e){for(var t=At(e),r=t.length;r--;){var o=t[r],n=e[o];t[r]=[o,n,Lr(n)]}return t};var Dr=function matchesStrictComparable(e,t){return function(r){return null!=r&&(r[e]===t&&(void 0!==t||e in Object(r)))}};var Rr=function baseMatches(e){var t=Ur(e);return 1==t.length&&t[0][2]?Dr(t[0][0],t[0][1]):function(r){return r===e||Nr(r,e,t)}};var $r=function isSymbol(e){return"symbol"==typeof e||I(e)&&"[object Symbol]"==g(e)},Fr=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,qr=/^\w*$/;var Br=function isKey(e,t){if(ft(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!$r(e))||(qr.test(e)||!Fr.test(e)||null!=t&&e in Object(t))};function memoize(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var memoized=function(){var r=arguments,o=t?t.apply(this,r):r[0],n=memoized.cache;if(n.has(o))return n.get(o);var i=e.apply(this,r);return memoized.cache=n.set(o,i)||n,i};return memoized.cache=new(memoize.Cache||Te),memoized}memoize.Cache=Te;var Hr=memoize;var Kr=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,zr=/\\(\\)?/g,Vr=function memoizeCapped(e){var t=Hr(e,(function(e){return 500===r.size&&r.clear(),e})),r=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(Kr,(function(e,r,o,n){t.push(o?n.replace(zr,"$1"):r||e)})),t})),Qr=s?s.prototype:void 0,Gr=Qr?Qr.toString:void 0;var Jr=function baseToString(e){if("string"==typeof e)return e;if(ft(e))return Ne(e,baseToString)+"";if($r(e))return Gr?Gr.call(e):"";var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var Wr=function toString(e){return null==e?"":Jr(e)};var Yr=function castPath(e,t){return ft(e)?e:Br(e,t)?[e]:Vr(Wr(e))};var Xr=function toKey(e){if("string"==typeof e||$r(e))return e;var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var Zr=function baseGet(e,t){for(var r=0,o=(t=Yr(t,e)).length;null!=e&&r<o;)e=e[Xr(t[r++])];return r&&r==o?e:void 0};var eo=function get(e,t,r){var o=null==e?void 0:Zr(e,t);return void 0===o?r:o};var to=function baseHasIn(e,t){return null!=e&&t in Object(e)};var ro=function hasPath(e,t,r){for(var o=-1,n=(t=Yr(t,e)).length,i=!1;++o<n;){var s=Xr(t[o]);if(!(i=null!=e&&r(e,s)))break;e=e[s]}return i||++o!=n?i:!!(n=null==e?0:e.length)&&Qe(n)&&St(s,n)&&(ft(e)||gt(e))};var oo=function hasIn(e,t){return null!=e&&ro(e,t,to)};var no=function baseMatchesProperty(e,t){return Br(e)&&Lr(t)?Dr(Xr(e),t):function(r){var o=eo(r,e);return void 0===o&&o===t?oo(r,e):Ar(t,o,3)}};var io=function baseProperty(e){return function(t){return null==t?void 0:t[e]}};var so=function basePropertyDeep(e){return function(t){return Zr(t,e)}};var ao=function property(e){return Br(e)?io(Xr(e)):so(e)};var co=function baseIteratee(e){return"function"==typeof e?e:null==e?De:"object"==typeof e?ft(e)?no(e[0],e[1]):Rr(e):ao(e)};var lo=function baseAssignValue(e,t,r){"__proto__"==t&&Be?Be(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r},uo=Object.prototype.hasOwnProperty;var ho=function assignValue(e,t,r){var o=e[t];uo.call(e,t)&&ce(o,r)&&(void 0!==r||t in e)||lo(e,t,r)};var mo=function baseSet(e,t,r,o){if(!f(e))return e;for(var n=-1,i=(t=Yr(t,e)).length,s=i-1,a=e;null!=a&&++n<i;){var c=Xr(t[n]),l=r;if("__proto__"===c||"constructor"===c||"prototype"===c)return e;if(n!=s){var u=a[c];void 0===(l=o?o(u,c,a):void 0)&&(l=f(u)?u:St(t[n+1])?[]:{})}ho(a,c,l),a=a[c]}return e};var po=function basePickBy(e,t,r){for(var o=-1,n=t.length,i={};++o<n;){var s=t[o],a=Zr(e,s);r(a,s)&&mo(i,Yr(s,e),a)}return i},go=Pt(Object.getPrototypeOf,Object),fo=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)or(t,lr(e)),e=go(e);return t}:sr;var yo=function nativeKeysIn(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t},vo=Object.prototype.hasOwnProperty;var bo=function baseKeysIn(e){if(!f(e))return yo(e);var t=Et(e),r=[];for(var o in e)("constructor"!=o||!t&&vo.call(e,o))&&r.push(o);return r};var So=function keysIn(e){return Ge(e)?_t(e,!0):bo(e)};var ko=function getAllKeysIn(e){return nr(e,So,fo)};var Co=function pickBy(e,t){if(null==e)return{};var r=Ne(ko(e),(function(e){return[e]}));return t=co(t),po(e,r,(function(e,r){return t(e,r[0])}))};const wo={"6_2":"getNosToken","6_22":"getOriginUrl","6_26":"getNosCdnHost","6_27":"getGrayscaleConfig","6_28":"getMixStorePolicy","6_29":"getMixStoreToken","6_30":"getFileAuthToken"},To={nosToken:{objectName:1,token:2,bucket:3,expireTime:4,expireSec:7,tag:8,shortUrl:9},mixStoreTokenReqTag:{provider:0,tokenCount:1,fileExpireSec:2,tag:3,returnBody:4},nosConfigTag:{bucket:1,cdnDomain:2,expire:3,objectNamePrefix:4},grayConfigTag:{config:0,ttl:1},mixStorePolicyTag:{providers:0,ttl:1,mixEnable:2,nosPolicy:3,s3Policy:4},mixStoreTokenResTag:{provider:0,accessKeyId:1,secretAccessKey:2,sessionToken:3,token:4,expireTime:5,bucket:6,objectName:7,fileExpireSec:8,tag:9,shortUrl:10,region:11},nosSafeUrlTag:{safeUrl:0,originUrl:1},mixStoreAuthTokenReqTag:{type:1,urls:2},mixStoreAuthTokenResTag:{type:1,tokens:2,token:3,ttl:4}},Mo=invertSerializeMap(To),_o={getNosToken:{sid:6,cid:2,service:"cloudStorage",response:[{type:"Property",name:"nosToken",reflectMapper:Mo.nosToken}],params:[{type:"String",name:"responseBody"},{type:"Property",name:"nosToken",entity:"nosToken",reflectMapper:To.nosToken}]},getOriginUrl:{sid:6,cid:22,service:"cloudStorage",response:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:Mo.nosSafeUrlTag}],params:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:To.nosSafeUrlTag}]},getNosCdnHost:{sid:6,cid:26,service:"misc",response:[{type:"Property",name:"nosConfigTag",reflectMapper:Mo.nosConfigTag}]},getGrayscaleConfig:{sid:6,cid:27,service:"cloudStorage",response:[{type:"Property",name:"grayConfigTag",reflectMapper:Mo.grayConfigTag}],params:[{type:"Property",name:"config"}]},getMixStorePolicy:{sid:6,cid:28,service:"cloudStorage",params:[{type:"LongArray",name:"supportType"}],response:[{type:"Property",name:"mixStorePolicyTag",reflectMapper:Mo.mixStorePolicyTag}]},getMixStoreToken:{sid:6,cid:29,service:"cloudStorage",params:[{type:"Property",name:"mixStoreTokenReqTag",reflectMapper:To.mixStoreTokenReqTag}],response:[{type:"Property",name:"mixStoreTokenResTag",reflectMapper:Mo.mixStoreTokenResTag}]},getFileAuthToken:{sid:6,cid:30,service:"cloudStorage",params:[{type:"Property",name:"mixStoreAuthTokenReqTag",reflectMapper:To.mixStoreAuthTokenReqTag}],response:[{type:"Property",name:"mixStoreAuthTokenResTag",reflectMapper:Mo.mixStoreAuthTokenResTag}]}};var xo,Eo;!function(e){e[e.nos=1]="nos",e[e.s3=2]="s3"}(xo||(xo={})),function(e){e[e.dontNeed=-1]="dontNeed",e[e.time=2]="time",e[e.urls=3]="urls"}(Eo||(Eo={}));const Po={chunkUploadHost:"https://wanproxy-web.127.net",commonUploadHost:"https://nos.netease.com",chunkMaxSize:4194304e4,commonMaxSize:104857600,uploadReplaceFormat:"https://{host}/{object}",cdn:{defaultCdnDomain:"nim.nosdn.127.net",cdnDomain:"",bucket:"",objectNamePrefix:""},downloadUrl:"https://{bucket}-nosdn.netease.im/{object}",downloadHostList:["nos.netease.com"],nosCdnEnable:!0,isNeedToGetUploadPolicyFromServer:!0},Oo={file:{md5:"$(Etag)",size:"$(ObjectSize)"},image:{md5:"$(Etag)",size:"$(ObjectSize)",w:"$(ImageInfo.Width)",h:"$(ImageInfo.Height)",orientation:"$(ImageInfo.Orientation)"},audio:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Audio.Duration)"},video:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Video.Duration)",w:"$(AVinfo.Video.Width)",h:"$(AVinfo.Video.Height)"}},Io={accessKeyId:"",secretAccessKey:"",sessionToken:"",region:"",maxRetries:0,bucket:"",objectName:"",token:"",shortUrl:""};function getUploadResponseFormat(e="file"){const t=Oo[e]||{};return JSON.stringify(t).replace(/"/gi,'\\"')}var jo,Ao,No;!function(e){e[e.nos=1]="nos",e[e.s3=2]="s3"}(jo||(jo={})),function(e){e[e.dontNeed=-1]="dontNeed",e[e.time=2]="time",e[e.urls=3]="urls"}(Ao||(Ao={}));class CloudStorageService{constructor(e,t={}){this.GRAYKEY="AllGrayscaleConfig",this.MIXSTOREKEY="AllMixStorePolicy",this.config={},this.nosCdnHostTimer=0,this.grayConfig={mixStoreEnable:!1,timeStamp:0,ttl:0},this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=jo.nos,this.s3=null,this.mixStoreErrorCount=10,this.nosErrorCount=0,this.circuitTimer=0,this.name="cloudStorage",this.logger=e.logger,this.core=e,registerParser({cmdMap:wo,cmdConfig:_o}),this.setOptions(t)}setOptions(e={}){const t=e.storageKeyPrefix||"NIMClient";this.GRAYKEY=t+"-AllGrayscaleConfig",this.MIXSTOREKEY=t+"-AllMixStorePolicy";const{s3:r}=e,o=__rest(e,["s3"]),n=Object.assign({},Po,this.config);if(o&&Object.prototype.hasOwnProperty.call(o,"cdn")){const e={cdn:Object.assign(Object.assign({},n.cdn),o.cdn)};this.config=Object.assign({},n,o,e)}else this.config=Object.assign({},n,o);r&&(this.s3=r)}init(){return __awaiter(this,void 0,void 0,(function*(){this.grayConfig=null,this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.curProvider=jo.nos,this.mixStoreErrorCount=10,this.config.isNeedToGetUploadPolicyFromServer&&(yield this.getGrayscaleConfig(this.core.options.appkey),yield this.getNosCdnHost())}))}uploadFile(e){return __awaiter(this,void 0,void 0,(function*(){if(validate({maxSize:{type:"number",required:!1},type:{type:"enum",values:["file","image","audio","video"]}},e),!e.fileInput&&!e.file&&!e.filePath)throw new Error("uploadFile needs target file object or a filePath");if(e.type&&"file"!==e.type){const t=eo(e,"file.type");if("string"==typeof t&&-1===t.indexOf(e.type))throw new Error(`The meta type "${t}" does not match "${e.type}"`)}if(!(this.grayConfig&&this.grayConfig.mixStoreEnable&&this.mixStorePolicy.providers.length))return this.logger.log("uploadFile:: uploadFile begin, use old nos"),this.nosUpload(e);this.logger.log(`uploadFile:: uploadFile begin,Current settings grayConfig mixStoreEnable:${this.grayConfig.mixStoreEnable} curProvider:${this.curProvider}`),this.s3||(this.curProvider=jo.nos);let t=Io;try{t=(yield this.core.sendCmd("getMixStoreToken",{mixStoreTokenReqTag:{provider:this.curProvider,tokenCount:1,tag:"qchat",returnBody:getUploadResponseFormat(e.type)}})).content.mixStoreTokenResTag}catch(e){throw this.core.logger.error("uploadFile:: getMixStoreToken error",e),new UploadError("getMixStoreToken error",e,this.curProvider,this.mixStorePolicy)}return this.curProvider===jo.s3?this.s3Upload(e,t):this.nosUpload(e,t)}))}nosUpload(e,t){var r,o;return __awaiter(this,void 0,void 0,(function*(){const n=eo(this.core,"config.cdn.bucket"),i={tag:e.nosScenes||n||"nim",expireSec:e.nosSurvivalTime};let s,a;if(!t)try{s=yield this.core.sendCmd("getNosToken",{responseBody:getUploadResponseFormat(e.type),nosToken:i})}catch(e){throw this.core.logger.error("uploadFile:: getNosToken error",e),new UploadError("getNosToken error",e,1)}try{const r=s?s.content.nosToken:t;this.core.logger.debug("uploadFile:: uploadFile params",{nosToken:r,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,platform:T.platform}),a=yield this.core.adapters.uploadFile(Object.assign(Object.assign({},e),{nosToken:r,chunkUploadHost:this.config.chunkUploadHost,commonUploadHost:this.config.commonUploadHost,maxSize:e.maxSize||this.config.chunkMaxSize}))}catch(o){if(this.core.logger.error("uploadFile::nos uploadFile error",o),t){if(0===this.nosErrorCount){try{this._addCircuitTimer()}catch(t){throw new UploadError("upload file error",t,this.curProvider,this.mixStorePolicy,e.file||e.filePath)}return this.nosErrorCount=null===(r=this.mixStorePolicy.nosPolicy)||void 0===r?void 0:r.uploadConfig.retryPolicy.retry,this.uploadFile(e)}return this.nosErrorCount--,this.nosUpload(e,t)}throw new UploadError("nos uploadFile error",o,1)}const c=null==a?void 0:a.type,l=c&&c.indexOf("/")>-1?c.slice(0,c.indexOf("/")):"",u={image:"imageInfo",video:"vinfo",audio:"vinfo"};let h,d=this.config.uploadReplaceFormat.replace("{host}",this.config.cdn.cdnDomain||this.config.cdn.defaultCdnDomain).replace("{object}",s?s.content.nosToken.objectName:null==t?void 0:t.objectName);if(t&&t.shortUrl&&(d=t.shortUrl),!u[l])return Object.assign({url:d},a);try{d.indexOf("_im_url=1")<0&&(h=yield this.core.adapters.request(`${d}?${u[l]}`,{method:"GET",dataType:"json",timeout:5e3}))}catch(e){return this.core.logger.error("uploadFile:: fetch file info error",e),Object.assign({url:d},a)}if(h){const{data:e}=h,t="imageInfo"===u[l]?e:null===(o=null==e?void 0:e.GetVideoInfo)||void 0===o?void 0:o.VideoInfo,r={url:d,name:a.name,size:a.size,ext:a.ext,w:t.Width,h:t.Height,orientation:t.Orientation,dur:t.Duration,audioCodec:t.AudioCodec,videoCodec:t.VideoCodec,container:t.Container};return Co(r,(function(e,t){return void 0!==t}))}return Object.assign({url:d},a)}))}getNosCdnHost(){var e;return __awaiter(this,void 0,void 0,(function*(){let t;try{t=yield this.core.sendCmd("getNosCdnHost")}catch(e){return void this.logger.error("getNosCdnHost::error",e)}if(!t)return;const r=null===(e=null==t?void 0:t.content)||void 0===e?void 0:e.nosConfigTag,o=parseInt(null==r?void 0:r.expire);0!==o&&r.cdnDomain?-1===o?(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix):(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix,this.nosCdnHostTimer=this.core.timerManager.addTimer((()=>{this.getNosCdnHost()}),1e3*o)):(this.config.cdn.bucket="",this.config.cdn.cdnDomain="",this.config.cdn.objectNamePrefix="")}))}getGrayscaleConfig(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(T.localStorage)try{T.localStorage.getItem&&T.localStorage.getItem(this.GRAYKEY)&&(this.grayConfig=JSON.parse(T.localStorage.getItem(this.GRAYKEY))[e])}catch(e){T.localStorage.getItem(this.GRAYKEY)&&this.core.logger.error("uploadFile:: JSON.parse grayscaleConfig error ",e)}if(!this.grayConfig||this.grayConfig.timeStamp+1e3*this.grayConfig.ttl<(new Date).getTime()){const t=yield this.core.sendCmd("getGrayscaleConfig",{config:{}});if(t.content&&t.content.grayConfigTag){this.logger.log("uploadFile::getAppGrayConfigRequest success ");try{this.grayConfig=JSON.parse(t.content.grayConfigTag.config),this.grayConfig.ttl=JSON.parse(t.content.grayConfigTag.ttl)}catch(e){this.logger.error("getGrayscaleConfig error",e)}if(!this.grayConfig)return;const r=T.localStorage.getItem(this.GRAYKEY)?JSON.parse(T.localStorage.getItem(this.GRAYKEY)):{};this.grayConfig.timeStamp=(new Date).getTime(),r[e]=this.grayConfig,T.localStorage.setItem(this.GRAYKEY,JSON.stringify(r))}else this.logger.debug("uploadFile:: result grayConfig:",t.content)}(null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable)&&(yield this._getMixStorePolicy(e))}))}_getMixStorePolicy(e){return __awaiter(this,void 0,void 0,(function*(){const t=(new Date).getTime();if(T.localStorage)try{if(this.mixStorePolicy=JSON.parse(T.localStorage.getItem(this.MIXSTOREKEY))[e],this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.timeStamp&&this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl>t){const r=this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl-t;this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,e),r)}}catch(t){T.localStorage.getItem(this.MIXSTOREKEY)&&JSON.parse(T.localStorage.getItem(this.MIXSTOREKEY))[e]&&this.core.logger.error("uploadFile:: JSON.parse mixStorePolicy error ",t)}if(!this.mixStorePolicy||this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl<=t)try{const t=(yield this.core.sendCmd("getMixStorePolicy",{supportType:this.s3?[1,2]:[1]})).content.mixStorePolicyTag;this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null},this.mixStorePolicy.ttl=Number(t.ttl),this.mixStorePolicy.providers=t.providers.split(","),this.circuitTimer&&this.core.timerManager.deleteTimer(this.circuitTimer),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.mixStorePolicy.nosPolicy=t.nosPolicy?JSON.parse(t.nosPolicy):null,this.mixStorePolicy.s3Policy=t.s3Policy?JSON.parse(t.s3Policy):null,null===this.mixStorePolicy.s3Policy?this.mixStorePolicy.providers=["1"]:null===this.mixStorePolicy.nosPolicy?this.mixStorePolicy.providers=["2"]:this.mixStorePolicy.providers=this.mixStorePolicy.s3Policy.priority<this.mixStorePolicy.nosPolicy.priority?["2","1"]:["1","2"],this.core.timerManager.addTimer(this._getMixStorePolicy.bind(this,e),1e3*this.mixStorePolicy.ttl);const r=T.localStorage.getItem(this.MIXSTOREKEY)?JSON.parse(T.localStorage.getItem(this.MIXSTOREKEY)):{};this.mixStorePolicy.timeStamp=(new Date).getTime(),r[e]=this.mixStorePolicy,T.localStorage.setItem(this.MIXSTOREKEY,JSON.stringify(r))}catch(t){if(this.logger.error("getMixStorePolicy error",t),0===this.mixStoreErrorCount)throw new Error("getMixStorePolicy all count error");this._getMixStorePolicy(e),this.mixStoreErrorCount--}this.mixStorePolicy.nosPolicy&&(this.nosErrorCount=this.mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry)}))}s3Upload(e,t){return __awaiter(this,void 0,void 0,(function*(){let r;if(e.file)r=e.file;else if("string"==typeof e.fileInput){this.logger.warn("fileInput will abandon,Please use file or filepath");const t=document.getElementById(e.fileInput);if(!(t&&t.files&&t.files[0]))throw new Error("Can not get file from fileInput");r=t.files[0]}else{if(!(e.fileInput&&e.fileInput.files&&e.fileInput.files[0]))throw new Error(`Can not get file from fileInput ${e.fileInput}`);r=e.fileInput.files[0]}if(!this.mixStorePolicy.s3Policy)throw new Error("dont get s3 policy");const o={accessKeyId:t.accessKeyId,secretAccessKey:t.secretAccessKey,sessionToken:t.sessionToken,region:t.region,maxRetries:this.mixStorePolicy.s3Policy.uploadConfig.retryPolicy.retry},n=new(0,this.s3);n.config.update(o);const i=decodeURIComponent(t.bucket),s=decodeURIComponent(t.objectName),a=r,c={Bucket:i,Key:s,Body:a,Metadata:{token:t.token},ContentType:a.type||"application/octet-stream"};this.core.logger.debug("uploadFile:: s3 upload params:",c);const l=n.upload(c);return new Promise((r=>{const o=(new Date).getTime();l.send(((n,i)=>{var s,c;if(n){this.logger.error("uploadFile:","api::s3:upload file failed",n),this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,trace_id:null===(c=null===(s=this.core)||void 0===s?void 0:s.socket)||void 0===c?void 0:c.sessionId,start_time:o,action:1}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof n.status?n.status:"number"==typeof n.code?n.code:0,description:n.message||`${n.code}`,operation_type:1,target:n.hostname}),this.core.reporter.reportTraceEnd("exceptions",1);try{this._addCircuitTimer()}catch(n){throw new UploadError("upload file error",n,this.curProvider,this.mixStorePolicy,e.file||e.filePath)}r(this.uploadFile(e))}else{let e=this.mixStorePolicy.s3Policy.cdnSchema;e=e.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn),e=e.replace("{objectName}",i.Key),r({size:a.size,name:a.name,url:t.shortUrl?t.shortUrl:e,ext:a.name.split(".")[1]||"unknown"})}}))}))}))}getPrivateUrl(e){var t;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),"";const[r,o,n,i,s,a,c,l]=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);if(null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable){const t=this._getUrlType(e);return t===jo.s3&&this.mixStorePolicy.s3Policy&&(e=this.mixStorePolicy.s3Policy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",a)),t===jo.nos&&this.mixStorePolicy.nosPolicy&&(e=this.mixStorePolicy.nosPolicy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",a)),e}const{downloadUrl:u,downloadHostList:h,nosCdnEnable:d}=this.config,m=this.config.cdn.cdnDomain,p=this.config.cdn.objectNamePrefix?decodeURIComponent(this.config.cdn.objectNamePrefix):"",g=decodeURIComponent(a),f=g.indexOf(p);if(m&&f>-1&&d)return`${o}${m}/${g.slice(f)}`;if(h.includes(i)&&a.includes("/")){const e=a.indexOf("/"),t=a.substring(0,e),r=a.substring(e+1);return u.replace("{bucket}",t).replace("{object}",r)}const y=h.filter((e=>"string"==typeof i&&i.includes(e)))[0],v=y?i.replace(y,"").replace(/\W/g,""):null;return v?u.replace("{bucket}",v).replace("{object}",a):e}getOriginUrl(e){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("getOriginUrl",{nosSafeUrlTag:{safeUrl:e}})).content.nosSafeUrlTag.originUrl}))}getFileToken(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"number",min:2,max:3},urls:{type:"array",required:!1,itemType:"string"}},e);const t=this.mixStorePolicy.nosPolicy?this.mixStorePolicy.nosPolicy.authPolicy.policyType:null,r=this.mixStorePolicy.s3Policy?this.mixStorePolicy.s3Policy.authPolicy.policyType:null;if(t===String(Ao.dontNeed)&&r===String(Ao.dontNeed))throw this.logger.error("don't need token"),new Error("don't need token");if(e.type===Ao.time){if(t&&t.indexOf(String(Ao.time))>=0||r&&r.indexOf(String(Ao.time))>0)return this.getFileAuthToken(e);throw this.logger.error("don't support time token "),new Error("don't support type time token ")}{if(!e.urls||!e.urls.length)throw this.logger.error("urls is required when urls token"),new Error("urls is required when urls token");let o=[],n=[];if(e.urls.forEach((e=>{const t=this._getUrlType(e);t===jo.nos&&n.push(e),t===jo.s3&&o.push(e)})),(!r||0!==o.length&&r.indexOf(String(Ao.urls))<0)&&(this.logger.warn("s3 url don't support url token"),o=[]),(!t||0!==n.length&&t.indexOf(String(Ao.urls))<0)&&(this.logger.warn("nos url don't support url token"),n=[]),0===o.length&&0===n.length)throw this.logger.error("not support urls"),new Error("not support urls");if(0===o.length||0===n.length)return e.urls=JSON.stringify(e.urls),this.getFileAuthToken(e)}}))}getFileAuthToken(e){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("getFileAuthToken",{mixStoreAuthTokenReqTag:e})).content.mixStoreAuthTokenResTag}))}_getUrlType(e){return this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.nosPolicy.dlcdns.some((t=>e.indexOf(t)>=0))?jo.nos:this.mixStorePolicy.s3Policy&&this.mixStorePolicy.s3Policy.dlcdns.some((t=>e.indexOf(t)>=0))?jo.s3:null}_addCircuitTimer(){const e=this.mixStorePolicy.providers,t=e[(e.indexOf(String(this.curProvider))+1)%e.length];if(t===e[0])throw new Error("uploadFile all policy fail");const r=eo(this.mixStorePolicy,"s3Policy.uploadConfig.retryPolicy");if(r&&r.retryNext&&t&&(this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${t}`),this.curProvider=parseInt(t),this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.s3Policy)){const e=this.mixStorePolicy[this.curProvider===jo.nos?"nosPolicy":"s3Policy"].uploadConfig.retryPolicy.circuit;if(!e||0===e)return;this.circuitTimer=this.core.timerManager.addTimer((()=>{this.logger.log(`uploadFile:: upload policy will change,now policy:${this.curProvider} nextProvider:${parseInt(this.mixStorePolicy.providers[0])}`),this.curProvider=parseInt(this.mixStorePolicy.providers[0]),this.core.timerManager.deleteTimer(this.circuitTimer)}),1e3*e)}}process(e){const t=this[e.cmd+"Handler"];return"function"==typeof t?t.call(this,e):e.error&&!e.error.ignore?Promise.reject(e.error):Promise.resolve(e)}}class ChatroomMsgService extends Service{constructor(e){super("chatroomMsg",e)}sendTextMsg(e){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"text"}))}sendGeoLocationMsg(e){return validate({body:{type:"object",rules:{title:{type:"string",allowEmpty:!1},lat:{type:"number"},lng:{type:"number"}}}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"geo",body:JSON.stringify(e.body)}))}sendTipMsg(e){return __awaiter(this,void 0,void 0,(function*(){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"tip"}))}))}sendCustomMsg(e){return __awaiter(this,void 0,void 0,(function*(){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Object.assign(Object.assign({},e),{type:"custom"}))}))}sendImageMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"image"}))}sendFileMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"file"}))}sendAudioMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"audio"}))}sendVideoMsg(e){return this.doSendFile(Object.assign(Object.assign({},e),{type:"video"}))}doSendFile(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"string",allowEmpty:!1},body:{type:"object",rules:{url:{type:"string",allowEmpty:!1}},required:!1},maxSize:{type:"number",min:1,required:!1}},e);let t=e.body;if(!t){if(!this.core.cloudStorage||!this.core.cloudStorage.uploadFile)throw new Error('Service "cloudStorage" does not exist');try{this.core.reporter.reportTraceStart("nos",{user_id:this.core.account,action:"upload"}),t=yield this.core.cloudStorage.uploadFile(e),this.core.reporter.reportTraceEnd("nos",!0)}catch(e){throw this.core.reporter.reportTraceUpdate("nos",{operation_type:"transfer",error:e},!1),this.core.reporter.reportTraceEnd("nos",!1),this.logger.error("sendFile:: upload File error or abort",e),e}try{e.onUploadDone&&e.onUploadDone(t)}catch(e){throw this.logger.error("sendFile options.onUploadDone err",e),e}}return this.sendMsg(Object.assign(Object.assign({},e),{body:JSON.stringify(t),type:e.type}))}))}queryMessageHistory(e){return __awaiter(this,void 0,void 0,(function*(){validate({timetag:{type:"number",required:!1},limit:{type:"number",min:1,max:100,required:!1},reverse:{type:"boolean",required:!1},msgTypes:{type:"array",itemType:"string",required:!1}},e);const t=yield this.core.sendCmd("chatroomQueryMessageHistory",Object.assign(Object.assign({timetag:0,limit:100,reverse:!1},e),{msgTypes:e.msgTypes?e.msgTypes.map((e=>Dt[e])):[]})),{chatroomMsgs:r}=t.content;return formatChatroomMsgs(r,this.core.account)}))}getHistoryMsgsByTags(e){return __awaiter(this,void 0,void 0,(function*(){validate({tags:{type:"array",itemType:"string",required:!0},types:{type:"array",itemType:"string",required:!1},fromTime:{type:"number",min:0,required:!1},toTime:{type:"number",min:0,required:!1},limit:{type:"number",min:0,required:!1},reverse:{type:"number",required:!1}},e);const t=Object.assign(Object.assign({fromTime:0,toTime:0,limit:100,reverse:0},e),{types:e.types?e.types.filter((e=>void 0!==Dt[e])).map((e=>Dt[e])):[]}),r=yield this.core.sendCmd("getHistoryMsgsByTags",{chatRoomTagHistoryMsgRequestTag:Object.assign(t,{tags:JSON.stringify(t.tags),types:JSON.stringify(t.types)})}),{chatroomMsgs:o}=r.content;return formatChatroomMsgs(o,this.core.account)}))}onChatroomMsgHandler(e){const t=e.content,r=Date.now(),o=formatChatroomMsg(null==t?void 0:t.chatroomMsg,this.core.account);if("debug"===this.core.options.debugLevel?this.logger.debug("onChatroomMsgHandler::recvMsg",o.type,o.idClient,o):this.logger.log("onChatroomMsgHandler::recvMsg",o.type,o.idClient),this.core.emit("chatroomMsg",o),"out"!==o.flow){const t={msgId:"",clientId:o.idClient,receiveTime:e.__receiveTime,serverTime:o.time,callbackTime:Date.now(),preHandleTime:r,fromAccid:o.from,toAccid:this.core.account,type:4,roomId:o.chatroomId,tid:"",result:200,failReason:"",rt:Date.now()-o.time};this.core.reporter.report("msgReceive",t,!0)}}sendMsg(e){return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"enum",values:getEnumKeys(Dt)},subType:{type:"number",min:1,required:!1}},e);const t=function generatorMsgForCmd(e,t,r){const o=__rest(e,["onSendBefore"]);return e.resend||(o.idClient=it()),o.type=Dt[e.type],o.from=t,o.fromClientType=16,o.fromDeviceId=r,o.status=o.status||"sending",["resend","needAntiSpam","antiSpamUsingYidun","skipHistory","highPriority","clientAntiSpam"].forEach((t=>{void 0!==e[t]&&(o[t]=e[t]?1:0)})),["subType"].forEach((t=>{void 0!==e[t]&&(o[t]=parseInt(e[t]))})),["body","antiSpamContent","antiSpamBusinessId","ext"].forEach((t=>{void 0!==e[t]&&(o[t]="string"==typeof e[t]?e[t]:JSON.stringify(e[t]))})),o}(e,this.core.account,this.core.config.deviceId),r=formatChatroomMsg(Object.assign(Object.assign({},t),{status:"sending",time:(new Date).getTime()}),this.core.account);try{e.onSendBefore&&e.onSendBefore(r)}catch(e){this.core.logger.error("sendMsg: options.onSendBefore error",e)}try{const e=yield this.core.sendCmd("sendChatroomMsg",{chatroomMsg:t}),o=formatChatroomMsg(Object.assign(Object.assign(Object.assign({},t),e.content.chatroomMsg),{status:"success"}),this.core.account);return this.core.reporter.report("msgSend",{msgId:"",clientId:o.idClient,msgTime:o.time,fromAccid:this.core.account,toAccid:"",type:4,roomId:o.chatroomId,tid:"",result:200,faiReason:"",rt:Date.now()-r.time}),o}catch(e){const r=formatChatroomMsg(Object.assign(Object.assign({},t),{status:"fail"}),this.core.account);throw e.msg=r,this.core.reporter.report("msgSend",{msgId:"",clientId:r.idClient,fromAccid:this.core.account,toAccid:"",type:4,roomId:r.chatroomId,tid:"",result:null==e?void 0:e.code,faiReason:(null==e?void 0:e.message)||"",rt:Date.now()-t.time}),e}}))}}!function(e){e[e.regular=0]="regular",e[e.temp=1]="temp",e[e.regularOnline=2]="regularOnline",e[e.regularReverse=3]="regularReverse"}(No||(No={}));class ChatroomMemberService extends Service{constructor(e){super("chatroomMember",e)}updateMyRoomRole(e){return __awaiter(this,void 0,void 0,(function*(){validate({member:{type:"object",rules:{nick:{type:"string",required:!1},avatar:{type:"string",required:!1},ext:{type:"string",required:!1}}},needNotify:{type:"boolean"},ext:{type:"string",required:!1},needSave:{type:"boolean",required:!1}},e),yield this.core.sendCmd("chatroomUpdateMyRoomRole",Object.assign(Object.assign({},e),{chatroomMember:e.member,ext:e.ext||""}))}))}setMemberManager(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.markChatroomMember(Object.assign(Object.assign({},e),{type:1}))}))}setMemberNormal(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.markChatroomMember(Object.assign(Object.assign({},e),{type:2}))}))}setMemberMute(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.markChatroomMember(Object.assign(Object.assign({},e),{type:-2}))}))}setMemberBlackList(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.markChatroomMember(Object.assign(Object.assign({},e),{type:-1}))}))}queryMembers(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({type:{type:"enum",values:getEnumKeys(No)},time:{type:"number",required:!1},limit:{type:"number",required:!1}},e);const r=yield this.core.sendCmd("chatroomQueryMembers",Object.assign(Object.assign({time:0,limit:100},e),{type:No[e.type]}));return formatChatroomMembers(null===(t=r.content)||void 0===t?void 0:t.members)}))}queryMembersByAccounts(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({accounts:{type:"array",min:1,max:20,itemType:"string"}},e);const r=yield this.core.sendCmd("chatroomQueryMembersByAccounts",e);return formatChatroomMembers(null===(t=r.content)||void 0===t?void 0:t.members)}))}setMemberTempMute(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},duration:{type:"number",min:0},needNotify:{type:"boolean",required:!1},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("chatroomSetMemberTempMute",Object.assign(Object.assign({},e),{ext:e.ext||""}))}))}kickMember(e){return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("chatroomKickMember",Object.assign(Object.assign({},e),{ext:e.ext||""}))}))}queryMembersCountByTag(e){return __awaiter(this,void 0,void 0,(function*(){validate({tag:{type:"string",allowEmpty:!1}},e);return(yield this.core.sendCmd("chatroomQueryMembersCountByTag",Object.assign({},e))).content.count}))}queryMembersByTag(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({tag:{type:"string",allowEmpty:!1},time:{type:"number",required:!1},limit:{type:"number",max:100,required:!1}},e);const r=yield this.core.sendCmd("chatroomQueryMembersByTag",{chatroomTagMemberReq:Object.assign({time:0,limit:100},e)});return formatChatroomMembers(null===(t=r.content)||void 0===t?void 0:t.members)}))}setMembersTempMuteByTag(e){return __awaiter(this,void 0,void 0,(function*(){validate({tag:{type:"string",allowEmpty:!1},duration:{type:"number",min:0},needNotify:{type:"boolean"},notifyTargetTags:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",required:!1}},e),yield this.core.sendCmd("chatroomSetMembersTempMuteByTag",{chatroomTagMuteReq:Object.assign(Object.assign({},e),{needNotify:e.needNotify?1:0,ext:e.ext||""})})}))}markChatroomMember(e){var t;return __awaiter(this,void 0,void 0,(function*(){validate({account:{type:"string"},isAdd:{type:"boolean"},ext:{type:"string",required:!1},level:{type:"number",required:!1}},e);const r=yield this.core.sendCmd("markChatroomMember",Object.assign(Object.assign({level:0},e),{ext:e.ext||""}));return formatChatroomMember(null===(t=r.content)||void 0===t?void 0:t.chatroomMember)}))}}class ChatroomQueueService extends Service{constructor(e){super("chatroomQueue",e)}init(e){return __awaiter(this,void 0,void 0,(function*(){validate({maxItemCount:{type:"number",min:0,max:1e3}},e),yield this.core.sendCmd("chatroomQueueInit",e)}))}update(e){return __awaiter(this,void 0,void 0,(function*(){validate({elementKey:{type:"string",allowEmpty:!1},elementValue:{type:"string",max:4096,allowEmpty:!1},transient:{type:"boolean",required:!1},account:{type:"string",required:!1}},e),yield this.core.sendCmd("chatroomQueueOffer",Object.assign(Object.assign({},e),{transient:!!e.transient}))}))}poll(e){return __awaiter(this,void 0,void 0,(function*(){validate({key:{type:"string",required:!1}},e),e.key||(e.key="");return(yield this.core.sendCmd("chatroomQueuePoll",e||{})).content}))}batchUpdate(e){return __awaiter(this,void 0,void 0,(function*(){validate({itemList:{type:"object"},needNotify:{type:"boolean",required:!1},notifyExtension:{type:"string",required:!1}},e);return(yield this.core.sendCmd("chatroomQueueChange",Object.assign(Object.assign({},e),{needNotify:!!e.needNotify}))).content.invalidKeyList}))}fetch(){return __awaiter(this,void 0,void 0,(function*(){return(yield this.core.sendCmd("chatroomQueueList")).content.itemList}))}pickHeader(){return __awaiter(this,void 0,void 0,(function*(){const e=yield this.core.sendCmd("chatroomQueuePeak");return{[e.content.elementKey]:e.content.elementValue}}))}clear(){return __awaiter(this,void 0,void 0,(function*(){yield this.core.sendCmd("chatroomQueueDrop")}))}}const Lo={"1_2":"heartbeat","13_2":"chatroomLogin","13_3":"beKickedFromChatroom","13_4":"chatroomExit","13_6":"sendChatroomMsg","13_7":"onChatroomMsg","13_8":"chatroomQueryMembers","13_9":"chatroomQueryMessageHistory","13_11":"markChatroomMember","13_12":"closeChatroom","13_13":"getChatroom","13_14":"updateChatroom","13_15":"chatroomUpdateMyRoomRole","13_16":"chatroomQueryMembersByAccounts","13_17":"chatroomKickMember","13_19":"chatroomSetMemberTempMute","13_20":"chatroomQueueOffer","13_21":"chatroomQueuePoll","13_22":"chatroomQueueList","13_23":"chatroomQueuePeak","13_24":"chatroomQueueDrop","13_25":"chatroomQueueInit","13_26":"chatroomQueueChange","13_30":"chatroomSetMembersTempMuteByTag","13_31":"chatroomQueryMembersByTag","13_32":"chatroomQueryMembersCountByTag","13_36":"getHistoryMsgsByTags","13_101":"updateChatroomTag"},Uo={chatroomLogin:{appkey:1,account:2,deviceId:3,chatroomId:5,appLogin:8,chatroomNick:20,chatroomAvatar:21,chatroomExt:22,chatroomEnterExt:23,session:26,isAnonymous:38,tags:39,notifyTargetTags:40,authType:41,loginExt:42},chatroomIMLogin:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,deviceId:13,appkey:18,account:19,browser:24,session:26,deviceInfo:32,token:1e3,customTag:38,customClientType:39,sdkHumanVersion:40,sdkType:41,userAgent:42,isReactNative:112,authType:115,loginExt:116},chatroomMsg:{idClient:1,type:2,body:3,ext:4,resend:5,userUpdateTime:6,fromNick:7,fromAvatar:8,fromExt:9,needAntiSpam:10,antiSpamContent:11,skipHistory:12,messageBody:13,antiSpamBusinessId:14,clientAntiSpam:15,antiSpamUsingYidun:16,time:20,from:21,chatroomId:22,fromClientType:23,highPriority:25,callbackExt:27,subType:28,yidunAntiCheating:29,env:30,notifyTargetTags:31,yidunAntiSpamExt:32,yidunAntiSpamRes:33},chatroom:{id:1,name:3,announcement:4,broadcastUrl:5,ext:12,createTime:14,updateTime:15,queuelevel:16,creator:100,onlineMemberNum:101,mute:102},chatroomMember:{chatroomId:1,account:2,type:3,level:4,nick:5,avatar:6,ext:7,online:8,guest:9,enterTime:10,blacked:12,muted:13,valid:14,updateTime:15,tempMuted:16,tempMuteDuration:17},chatroomTagMemberReq:{tag:1,time:2,limit:3},chatroomTagMuteReq:{tag:1,duration:2,needNotify:3,ext:4,notifyTargetTags:5},chatroomCdnInfo:{enable:1,cdnUrls:2,timestamp:3,interval:4,decryptType:5,decryptKey:6,timeout:7},chatRoomTagHistoryMsgRequestTag:{tags:1,types:2,fromTime:3,toTime:4,limit:5,reverse:6},updateTags:{currentTags:1}},Do=invertSerializeMap(Uo),Ro={heartbeat:{sid:1,cid:2,service:"chatroom"},chatroomLogin:{sid:13,cid:2,service:"chatroom",params:[{type:"Byte",name:"type"},{type:"Property",name:"chatroomLogin",reflectMapper:Uo.chatroomLogin},{type:"Property",name:"chatroomIMLogin",reflectMapper:Uo.chatroomIMLogin}],response:[{type:"Property",name:"chatroom",reflectMapper:Do.chatroom},{type:"Property",name:"chatroomMember",reflectMapper:Do.chatroomMember},{type:"Property",name:"chatroomCdnInfo",reflectMapper:Do.chatroomCdnInfo}]},chatroomExit:{sid:13,cid:4,service:"chatroom"},sendChatroomMsg:{sid:13,cid:6,service:"chatroomMsg",params:[{type:"Property",name:"chatroomMsg",reflectMapper:Uo.chatroomMsg}],response:[{type:"Property",name:"chatroomMsg",reflectMapper:Do.chatroomMsg}]},chatroomQueryMessageHistory:{sid:13,cid:9,service:"chatroomMsg",params:[{type:"Long",name:"timetag"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"chatroomMsgs",reflectMapper:Do.chatroomMsg}]},getHistoryMsgsByTags:{sid:13,cid:36,service:"chatroomMsg",params:[{type:"Property",name:"chatRoomTagHistoryMsgRequestTag",reflectMapper:Uo.chatRoomTagHistoryMsgRequestTag}],response:[{type:"PropertyArray",name:"chatroomMsgs",reflectMapper:Do.chatroomMsg}]},getChatroom:{sid:13,cid:13,service:"chatroom",response:[{type:"Property",name:"chatroom",reflectMapper:Do.chatroom}]},updateChatroom:{sid:13,cid:14,service:"chatroom",params:[{type:"Property",name:"chatroom",reflectMapper:Uo.chatroom},{type:"Bool",name:"needNotify"},{type:"String",name:"ext"}]},chatroomUpdateMyRoomRole:{sid:13,cid:15,service:"chatroomMember",params:[{type:"Property",name:"chatroomMember",reflectMapper:Uo.chatroomMember},{type:"Bool",name:"needNotify"},{type:"String",name:"ext"},{type:"Bool",name:"needSave"}]},markChatroomMember:{sid:13,cid:11,service:"chatroomMember",params:[{type:"String",name:"account"},{type:"Int",name:"type"},{type:"Bool",name:"isAdd"},{type:"Int",name:"level"},{type:"String",name:"ext"}],response:[{type:"Property",name:"chatroomMember",reflectMapper:Do.chatroomMember}]},chatroomQueryMembers:{sid:13,cid:8,service:"chatroomMember",params:[{type:"Byte",name:"type"},{type:"Long",name:"time"},{type:"Int",name:"limit"}],response:[{type:"PropertyArray",name:"members",reflectMapper:Do.chatroomMember}]},chatroomQueryMembersByAccounts:{sid:13,cid:16,service:"chatroomMember",params:[{type:"StrArray",name:"accounts"}],response:[{type:"PropertyArray",name:"members",reflectMapper:Do.chatroomMember}]},chatroomKickMember:{sid:13,cid:17,service:"chatroomMember",params:[{type:"string",name:"account"},{type:"string",name:"ext"}]},chatroomSetMemberTempMute:{sid:13,cid:19,service:"chatroomMember",params:[{type:"String",name:"account"},{type:"Long",name:"duration"},{type:"bool",name:"needNotify"},{type:"String",name:"ext"}]},closeChatroom:{sid:13,cid:12,service:"chatroom",params:[{type:"String",name:"ext"}]},chatroomQueryMembersCountByTag:{sid:13,cid:32,service:"chatroomMember",params:[{type:"String",name:"tag"}],response:[{type:"Long",name:"count"}]},chatroomQueryMembersByTag:{sid:13,cid:31,service:"chatroomMember",params:[{type:"Property",name:"chatroomTagMemberReq",reflectMapper:Uo.chatroomTagMemberReq}],response:[{type:"PropertyArray",name:"members",reflectMapper:Do.chatroomMember}]},chatroomSetMembersTempMuteByTag:{sid:13,cid:30,service:"chatroomMember",params:[{type:"Property",name:"chatroomTagMuteReq",reflectMapper:Uo.chatroomTagMuteReq}]},chatroomQueueOffer:{sid:13,cid:20,service:"chatroomQueue",params:[{type:"String",name:"elementKey"},{type:"String",name:"elementValue"},{type:"bool",name:"transient"},{type:"String",name:"account"}]},chatroomQueuePoll:{sid:13,cid:21,service:"chatroomQueue",params:[{type:"String",name:"key"}],response:[{type:"String",name:"elementKey"},{type:"String",name:"elementValue"}]},chatroomQueueChange:{sid:13,cid:26,service:"chatroomQueue",params:[{type:"StrStrMap",name:"itemList"},{type:"bool",name:"needNotify"},{type:"String",name:"notifyExtension"}],response:[{type:"StrArray",name:"invalidKeyList"}]},chatroomQueueList:{sid:13,cid:22,service:"chatroomQueue",response:[{type:"KVArray",name:"itemList"}]},chatroomQueuePeak:{sid:13,cid:23,service:"chatroomQueue",response:[{type:"String",name:"elementKey"},{type:"String",name:"elementValue"}]},chatroomQueueDrop:{sid:13,cid:24,service:"chatroomQueue"},chatroomQueueInit:{sid:13,cid:25,service:"chatroomQueue",params:[{type:"Int",name:"maxItemCount"}]},onChatroomMsg:{sid:13,cid:7,service:"chatroomMsg",response:[{type:"Property",name:"chatroomMsg",reflectMapper:Do.chatroomMsg}]},beKickedFromChatroom:{sid:13,cid:3,service:"chatroom",response:[{type:"Number",name:"reason"},{type:"String",name:"ext"}]},updateChatroomTag:{sid:13,cid:101,service:"chatroom",response:[{type:"Property",name:"updateTags",reflectMapper:Do.updateTags}]}},$o={BROWSER:0,RN:2,UNIAPP:3,WECHAT:6},Fo={debugLevel:"off",needReconnect:!0,reconnectionAttempts:Number.MAX_SAFE_INTEGER,autoMarkRead:!0,isAbtestEnable:!0,abtestUrl:"https://abt-online.netease.im/v1/api/abt/client/getExperimentInfo",abtestProjectKey:"imElite_sdk_abtest_web"};class Chatroom extends Core{constructor(e,t={}){super(e),this.instanceName="Chatroom",this.account="",this.options={},this.chatroom={},this.chatroomMsg={},this.chatroomMember={},this.chatroomQueue={},this.cloudStorage={},this.setOptions(e),registerParser({cmdMap:Lo,cmdConfig:Ro}),registerParser({cmdMap:wo,cmdConfig:_o}),this.chatroom=new ChatroomService(this),this.chatroomMsg=new ChatroomMsgService(this),this.chatroomMember=new ChatroomMemberService(this),this.chatroomQueue=new ChatroomQueueService(this),this.cloudStorage=new CloudStorageService(this,Object.assign({storageKeyPrefix:this.instanceName},t.cloudStorageConfig)),Chatroom.instance=this}static getInstance(e,t){if(!Chatroom.instance){if(e)return new Chatroom(e,t);throw new Error("Instance not exist, please input options")}if(e){if(Chatroom.instance.options.account===e.account&&Chatroom.instance.options.appkey===e.appkey)return Chatroom.instance.setOptions(e),Chatroom.instance;throw new Error("Unexpected login")}return Chatroom.instance}setOptions(e){validate({account:{type:"string"},appkey:{type:"string"},token:{type:"string"},chatroomId:{type:"string"},chatroomAddresses:{type:"array",itemType:"string",min:1},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},isAnonymous:{type:"boolean",required:!1},tags:{type:"array",itemType:"string",required:!1}},e),this.logger.log("chatroom::setOptions options is",e),this.account=e.account,this.options=Object.assign(Object.assign({},Fo),e)}connect(e={}){const t=Object.create(null,{connect:{get:()=>super.connect}});return __awaiter(this,void 0,void 0,(function*(){if(!/^(unconnected|waitReconnect)$/.test(this.status)){const e=`Chatroom status is ${this.status}, and would not connect`;return this.logger.warn(e),Promise.reject(e)}const r=e.isAutoReconnect||!1,o=Date.now(),n=yield t.connect.call(this,{linkUrls:this.options.chatroomAddresses,isAutoReconnect:r});let i;try{i=yield this.login(r),this.reporter.report("chatroomLogin",{accid:this.account,roomId:this.options.chatroomId,serverIps:this.options.chatroomAddresses,currentServerIp:n,rt:Date.now()-o,result:200,failReason:"",time:Date.now()})}catch(e){if(this.logger.error("chatroom login error",e),this.reporter.report("chatroomLogin",{accid:this.account,roomId:this.options.chatroomId,serverIps:this.options.chatroomAddresses,currentServerIp:n,rt:Date.now()-o,result:e&&e.error&&e.error.code,failReason:e&&e.error&&e.error.message,time:Date.now()}),0===this.retryCount)throw this.doDisconnect(st.ACTIVE,"FailedToInitializeLogin"),e;return void this.doDisconnect(st.OFFLINE,"ReconnectLoginFailed")}try{yield this.cloudStorage.init()}catch(e){this.logger.error("NIM:login cloudStorage init failed ",e)}this.eventBus.emit("logined",i),this.emit("logined",i),this.resetConnectStatus(),this.ping()}))}login(e=!1){var t,r;return __awaiter(this,void 0,void 0,(function*(){const o=this.options,n=T.getSystemInfo(),i=Object.assign(Object.assign({},o),{appLogin:e?0:1,deviceId:this.config.deviceId,clientType:16,protocolVersion:1,sdkVersion:90903,sdkHumanVersion:"0.12.3",os:n.os,browser:n.browser,session:null===(t=this.socket)||void 0===t?void 0:t.sessionId,sdkType:$o[T.platform]||0,userAgent:"Native/0.12.3"}),s=Object.assign(Object.assign({},o),{appkey:o.appkey,account:o.account,deviceId:this.config.deviceId,session:null===(r=this.socket)||void 0===r?void 0:r.sessionId,appLogin:1});o.isAnonymous&&(s.isAnonymous=1,s.account=s.account||`nimanon_${it()}`,i.account=s.account,s.chatroomNick=s.account||`nimanon_${it()}`,s.chatroomAvatar=s.chatroomAvatar||" "),o.tags&&o.tags.length>0&&(s.tags=JSON.stringify(o.tags));const a=yield this.sendCmd("chatroomLogin",{type:1,chatroomLogin:s,chatroomIMLogin:i});this.status="logined";return{chatroom:formatChatroom(a.content.chatroom),member:formatChatroomMember(a.content.chatroomMember)}}))}onMessage(e){var t,r;const o=super.onMessage(e);if(!o)return;const n=o.raw.ser,i=this.sendingCmdMap.get(n);if(i&&i.cmd===o.cmd){const{callback:e,timer:r,params:s}=i;if(clearTimeout(r),o.params=s,this.sendingCmdMap.delete(n),"heartbeat"===o.cmd)return void e[0]();const a=null===(t=this[o.service])||void 0===t?void 0:t.process(o);a&&"function"==typeof a.then?a.then((t=>{e[0](t)})).catch((t=>{e[1](t)})):(this.logger.log("imsocket:: handlerFn without promise",o.service,o.cmd),e[0]())}else null===(r=this[o.service])||void 0===r||r.process(o)}disconnect(){switch(this.status){case"connected":case"logined":return this.sendCmd("chatroomExit").then((()=>{super.doDisconnect(st.ACTIVE,"UserActiveDisconnect")}));case"connecting":case"waitReconnect":return super.doDisconnect(st.ACTIVE,"UserActiveDisconnect"),Promise.resolve();case"unconnected":case"destroyed":return Promise.resolve()}}destroy(){return Chatroom.instance=null,super.destroy()}}Chatroom.instance=null;let qo=console;const Bo={clear(){try{my.clearStorageSync()}catch(e){qo.error("ali-app::ws: clearStorage ",e)}},getItem:e=>my.getStorageSync({key:e}).data,setItem:(e,t)=>my.setStorageSync({key:e,data:t}),removeItem:e=>my.removeStorageSync({key:e})};const Ho={setLogger(e){qo=e},platform:"ALIAPP",localStorage:Bo,request:function request$3(e,t){return new Promise(((r,o)=>{my.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.status,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){o(e)}}))}))},WebSocket:class WebSocket$3{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.onclose=function(e){qo.log("my-app: sockets on close ",e)},this.onerror=function(e){qo.error("my-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(e){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING,this.socketTask=my.connectSocket({url:this.url,multiple:!0,fail:e=>{this.errorHandler(e)},success:()=>{this.readyState=this.OPEN}}),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.onmessage&&this.onmessage({type:"open",header:e})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;const{code:t,reason:r,wasClean:o}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:o,type:"close"}),this.socketTask=null})),this.socketTask.onMessage((e=>{const t="object"==typeof e.data&&null!==e.data?e.data.data:e.data;this.onmessage&&this.onmessage({data:t})}))}close(){this.socketTask&&this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`my-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("my-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask&&this.socketTask.send({data:e,isBuffer:e instanceof ArrayBuffer})}errorHandler(e){qo.error("my-app::ws: onerror ",e),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}},uploadFile:function uploadFile$3(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{const o=my.uploadFile({url:e.commonUploadHost?`${e.commonUploadHost}/${e.nosToken.bucket}`:"https://nos.netease.com/nim",formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},fileType:e.type,fileName:"file",filePath:e.filePath,success(o){if(200==o.statusCode)try{const r=JSON.parse(o.data);r.name=e.filePath,r.ext=r.name.lastIndexOf(".")>-1?r.name.slice(r.name.lastIndexOf(".")+1).toLowerCase():"",t(r)}catch(e){r(new Error(`Upload Error parse result error: ${o.data}`))}else r(new Error(`Upload error ${o.statusCode}: ${o.errMsg}`))},fail(e){r(e)}});try{e.onUploadStart&&e.onUploadStart(o)}catch(e){qo.error("uploadFile: options.onUploadStart error",e),o.abort(),r(e)}e.onUploadProgress&&o.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToWrite,loaded:t.totalBytesWritten,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))},getSystemInfo:function getSystemInfo$3(){const e=my.getSystemInfoSync()||{};return{os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",hostEnv:"ALIAPP",hostEnvVer:e.version,hostInfo:"",pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}};let Ko=console;const zo={clear(){try{wx.clearStorageSync()}catch(e){Ko.error("wx-app::ws: clearStorage ",e)}},getItem:e=>wx.getStorageSync(e),setItem:(e,t)=>wx.setStorageSync(e,t),removeItem:e=>wx.removeStorageSync(e)};const Vo={setLogger(e){Ko=e},platform:"WXAPP",localStorage:zo,request:function request$2(e,t){return t&&(t.header=t.headers),new Promise(((r,o)=>{wx.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.statusCode,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){o(e)}}))}))},WebSocket:class WebSocket$2{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.onclose=function(e){Ko.log("wx-app: sockets on close ",e)},this.onerror=function(e){Ko.error("wx-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(e){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING;const r=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=wx.connectSocket(Object.assign(Object.assign({url:this.url},r),{fail:e=>{this.errorHandler(e)},success:()=>{}})),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.onmessage&&this.onmessage({type:"open",header:e})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;const{code:t,reason:r,wasClean:o}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:o,type:"close"})})),this.socketTask.onMessage((e=>{this.onmessage&&this.onmessage(e)}))}close(){this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`wx-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("wx-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask.send({data:e})}errorHandler(e){Ko.error("wx-app::ws: onerror ",e),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}},uploadFile:function uploadFile$2(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{const o=wx.uploadFile({url:e.commonUploadHost?`${e.commonUploadHost}/${e.nosToken.bucket}`:"https://nos.netease.com/nim",formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:e.filePath,success(o){if(200==o.statusCode)try{const r=JSON.parse(o.data);r.name=e.filePath,r.ext=r.name.lastIndexOf(".")>-1?r.name.slice(r.name.lastIndexOf(".")+1).toLowerCase():"",t(r)}catch(e){r(new Error(`Upload Error parse result error: ${o.data}`))}else r(new Error(`Upload error ${o.statusCode}: ${o.errMsg}`))},fail(e){r(e)}});try{e.onUploadStart&&e.onUploadStart(o)}catch(e){Ko.error("uploadFile: options.onUploadStart error",e),o.abort(),r(e)}e.onUploadProgress&&o.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToSend,loaded:t.totalBytesSent,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))},getSystemInfo:function getSystemInfo$2(){const e=wx.getSystemInfoSync()||{};return{os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",hostEnv:"WXAPP",hostEnvVer:e.version,hostInfo:e.SDKVersion,pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}};let Qo=console;const Go={clear(){try{swan.clearStorageSync()}catch(e){Qo.error("baidu-app::ws: clearStorage ",e)}},getItem:e=>swan.getStorageSync(e),setItem:(e,t)=>swan.setStorageSync(e,t),removeItem:e=>swan.removeStorageSync(e)};const Jo={setLogger(e){Qo=e},platform:"BAIDUAPP",localStorage:Go,request:function request$1(e,t){return t&&(t.header=t.headers),new Promise(((r,o)=>{swan.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.statusCode,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){o(e)}}))}))},WebSocket:class WebSocket$1{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.onclose=function(e){Qo.log("baidu-app: sockets on close ",e)},this.onerror=function(e){Qo.error("baidu-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(e){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING;const r=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=swan.connectSocket(Object.assign(Object.assign({url:this.url},r),{fail:e=>{this.errorHandler(e)},success:()=>{}})),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.onmessage&&this.onmessage({type:"open",header:e})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;const{code:t,reason:r,wasClean:o}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:o,type:"close"})})),this.socketTask.onMessage((e=>{this.onmessage&&this.onmessage({data:e.data})}))}close(){this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{this.socketTask=null}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`wx-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("wx-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask.send({data:e})}errorHandler(e){this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}},uploadFile:function uploadFile$1(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{const o=swan.uploadFile({url:e.commonUploadHost?`${e.commonUploadHost}/${e.nosToken.bucket}`:"https://nos.netease.com/nim",formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:e.filePath,success(o){if(200==o.statusCode)try{const r=JSON.parse(o.data);r.name=e.filePath,r.ext=r.name.lastIndexOf(".")>-1?r.name.slice(r.name.lastIndexOf(".")+1).toLowerCase():"",t(r)}catch(e){r(new Error(`Upload Error parse result error: ${o.data}`))}else r(new Error(`Upload error ${o.statusCode}: ${o.errMsg}`))},fail(e){r(e)}});try{e.onUploadStart&&e.onUploadStart(o)}catch(e){Qo.error("uploadFile: options.onUploadStart error",e),o.abort(),r(e)}e.onUploadProgress&&o.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToSend,loaded:t.totalBytesSent,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))},getSystemInfo:function getSystemInfo$1(){const e=swan.getSystemInfoSync()||{};return{os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",hostEnv:"BAIDUAPP",hostEnvVer:e.version,hostInfo:e.SDKVersion,pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}};let Wo=console;const Yo={clear(){try{tt.clearStorageSync()}catch(e){Wo.error("tt-app::ws: clearStorage ",e)}},getItem:e=>tt.getStorageSync(e),setItem:(e,t)=>tt.setStorageSync(e,t),removeItem:e=>tt.removeStorageSync(e)};const Xo={WX:Vo,ALI:Ho,BAIDU:Jo,TT:{setLogger(e){Wo=e},platform:"TTAPP",localStorage:Yo,request:function request(e,t){return t&&(t.header=t.headers),new Promise(((r,o)=>{tt.request(Object.assign(Object.assign({url:e},t),{success:function(e){e={data:e.data,status:e.statusCode,errMsg:e.errMsg,header:e.header},r(e)},fail:function(e){o(e)}}))}))},WebSocket:class WebSocket{constructor(e,t=""){if(this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.onclose=function(e){Wo.log("wx-app: sockets on close ",e)},this.onerror=function(e){Wo.error("wx-app: sockets error ",e)},this.onmessage=function(e){},this.onopen=function(e){},!e)throw new Error("Failed to construct 'socket': url required");this.url=e.replace(/:443(\/|$)/,"$1"),this.protocol=t,this.readyState=this.CONNECTING;const r=this.protocol?{protocols:[this.protocol]}:{};this.socketTask=tt.connectSocket(Object.assign(Object.assign({url:this.url},r),{fail:e=>{this.errorHandler(e)},success:()=>{}})),this.socketTask.onOpen((e=>{this.readyState=this.OPEN,this.onmessage&&this.onmessage({type:"open",header:e.header})})),this.socketTask.onError((e=>{this.errorHandler(e)})),this.socketTask.onClose((e=>{this.readyState=this.CLOSED;const{code:t,reason:r,wasClean:o}=e;"function"==typeof this.onclose&&this.onclose&&this.onclose({code:t,reason:r,wasClean:o,type:"close"})})),this.socketTask.onMessage((e=>{this.onmessage&&this.onmessage({data:e.data})}))}close(){this.socketTask&&this.socketTask.close({code:1e3,reason:"user force close websocket",complete:()=>{}})}send(e){if(this.readyState!==this.OPEN)throw new Error(`tt-app: socket sendMsg when readyState=${this.readyState}`);if(!("string"==typeof e||e instanceof ArrayBuffer))throw new TypeError("tt-app: socket sendMsg only String/ArrayBuffer supported");this.socketTask&&this.socketTask.send({data:e})}errorHandler(e){Wo.error("tt-app::ws: onerror ",e),this.readyState=this.CLOSED,this.onerror&&this.onerror({type:"error",message:e&&e.errMsg})}},uploadFile:function uploadFile(e){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(((t,r)=>{const o=tt.uploadFile({url:e.commonUploadHost?`${e.commonUploadHost}/${e.nosToken.bucket}`:"https://nos.netease.com/nim",formData:{Object:decodeURIComponent(e.nosToken.objectName),"x-nos-token":e.nosToken.token,"x-nos-entity-type":"json"},name:"file",filePath:e.filePath,success(o){if(200==o.statusCode)try{const r=JSON.parse(o.data);r.name=e.filePath,r.ext=r.name.lastIndexOf(".")>-1?r.name.slice(r.name.lastIndexOf(".")+1).toLowerCase():"",t(r)}catch(e){r(new Error(`Upload Error parse result error: ${o.data}`))}else r(new Error(`Upload error ${o.statusCode}: ${o.errMsg}`))},fail(e){r(e)}});try{e.onUploadStart&&e.onUploadStart(o)}catch(e){Wo.error("uploadFile: options.onUploadStart error",e),o.abort(),r(e)}e.onUploadProgress&&o.onProgressUpdate((function(t){e.onUploadProgress&&e.onUploadProgress({total:t.totalBytesExpectedToSend,loaded:t.totalBytesSent,percentage:t.progress,percentageText:t.progress+"%"})}))}))}))},getSystemInfo:function getSystemInfo(){const e=tt.getSystemInfoSync()||{};return{os:e.platform||"",osVer:e.system||"",browser:"",browserVer:"",hostEnv:"TTAPP",hostEnvVer:e.version,hostInfo:e.SDKVersion,pushDeviceInfo:{PRODUCT:e.model,DEVICE:e.model,MANUFACTURER:e.brand}}}}}[function getMiniappEnv(){return"undefined"!=typeof tt&&tt.getSystemInfo?"TT":"undefined"!=typeof swan&&swan.getSystemInfo?"BAIDU":"undefined"!=typeof my&&my.getSystemInfo?"ALI":"undefined"!=typeof wx&&wx.getSystemInfo?"WX":"unknow environment"}()];return Chatroom.setAdapters(Xo),Chatroom}));
