"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.log404 = void 0;
const route_1 = require("../../shared/route");
const utils_1 = require("../utils");
const RenderErrorPage_1 = require("./RenderErrorPage");
async function log404(pageContext) {
    const { urlPathname } = pageContext;
    if ((0, RenderErrorPage_1.isRenderErrorPageException)(pageContext.errorWhileRendering)) {
        (0, utils_1.assertInfo)(false, `\`throw RenderErrorPage()\` was thrown while rendering URL \`${urlPathname}\`. (This info isn't shown in production.)`, { onlyOnce: false });
        return;
    }
    const { pageRoutes } = await (0, route_1.loadPageRoutes)(pageContext);
    (0, utils_1.assertUsage)(pageRoutes.length > 0, 'No page found. Create a file that ends with the suffix `.page.js` (or `.page.vue`, `.page.jsx`, ...).');
    if (!pageContext._isProduction && !isFileRequest(urlPathname) && !pageContext._isPageContextRequest) {
        (0, utils_1.assertInfo)(false, [
            `URL \`${urlPathname}\` isn't matching any of your ${pageRoutes.length} page routes. See https://vite-plugin-ssr.com/routing and/or set the environment variable \`DEBUG=vps:routing\` for more information. (This info isn't shown in production.) Your page routes:`,
            ...getPagesAndRoutesInfo(pageRoutes)
        ].join('\n'), { onlyOnce: false });
    }
}
exports.log404 = log404;
function getPagesAndRoutesInfo(pageRoutes) {
    return pageRoutes
        .map((pageRoute) => {
        let route_humanReadable;
        let routeType_humanReadable;
        if (pageRoute.routeType === 'STRING') {
            route_humanReadable = pageRoute.routeString;
            routeType_humanReadable = 'Route String';
        }
        else if (pageRoute.routeType === 'FUNCTION') {
            route_humanReadable = truncateString(String(pageRoute.routeFunction).split(/\s/).filter(Boolean).join(' '), 64);
            routeType_humanReadable = 'Route Function';
        }
        else {
            route_humanReadable = pageRoute.routeString;
            routeType_humanReadable = 'Filesystem Route';
        }
        return `\`${route_humanReadable}\` (${routeType_humanReadable} of \`${pageRoute.pageId}.page.*\`)`;
    })
        .sort(utils_1.compareString)
        .map((line, i) => {
        const nth = (i + 1).toString().padStart(pageRoutes.length.toString().length, '0');
        return ` (${nth}) ${line}`;
    });
}
function truncateString(str, len) {
    if (len > str.length) {
        return str;
    }
    else {
        str = str.substring(0, len);
        return str + '...';
    }
}
function isFileRequest(urlPathname) {
    (0, utils_1.assert)(urlPathname.startsWith('/'));
    const paths = urlPathname.split('/');
    const lastPath = paths[paths.length - 1];
    (0, utils_1.assert)(typeof lastPath === 'string');
    const parts = lastPath.split('.');
    if (parts.length < 2) {
        return false;
    }
    const fileExtension = parts[parts.length - 1];
    (0, utils_1.assert)(typeof fileExtension === 'string');
    return /^[a-z0-9]+$/.test(fileExtension);
}
